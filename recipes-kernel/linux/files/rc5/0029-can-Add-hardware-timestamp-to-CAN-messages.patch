From f4203cce9f8b2d4d5ce1d80c2df82a1984b7b9c9 Mon Sep 17 00:00:00 2001
From: Ghennadi Procopciuc <ghennadi.procopciuc@nxp.com>
Date: Mon, 2 Aug 2021 08:08:44 +0300
Subject: [PATCH 29/49] can: Add hardware timestamp to CAN messages

commit f4203cce9f8b2d4d5ce1d80c2df82a1984b7b9c9 from
https://source.codeaurora.org/external/autobsps32/linux

Upstream-Status: Pending

Issue: ALB-5830
Signed-off-by: Ghennadi Procopciuc <ghennadi.procopciuc@nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 drivers/net/can/llce_can.c | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/drivers/net/can/llce_can.c b/drivers/net/can/llce_can.c
index b2824de76952..11dab33042d7 100644
--- a/drivers/net/can/llce_can.c
+++ b/drivers/net/can/llce_can.c
@@ -609,6 +609,16 @@ static int release_rx_index(struct llce_can *llce, uint32_t index)
 	return send_rx_msg(llce, &msg);
 }
 
+static void add_hwtimestamp(struct sk_buff *skb, u32 timestamp)
+{
+	struct skb_shared_hwtstamps *shhwtstamps;
+
+	shhwtstamps = skb_hwtstamps(skb);
+
+	/* Report cycles as seconds */
+	shhwtstamps->hwtstamp = ms_to_ktime(timestamp * 1000);
+}
+
 static void process_rx_msg(struct llce_can *llce, struct llce_can_mb *can_mb)
 {
 	struct net_device *dev = llce->can.dev;
@@ -657,6 +667,8 @@ static void process_rx_msg(struct llce_can *llce, struct llce_can_mb *can_mb)
 	net_stats->rx_packets++;
 	net_stats->rx_bytes += cf->len;
 
+	add_hwtimestamp(skb, can_mb->timestamp);
+
 	netif_receive_skb(skb);
 
 notif_exit:
-- 
2.17.1

