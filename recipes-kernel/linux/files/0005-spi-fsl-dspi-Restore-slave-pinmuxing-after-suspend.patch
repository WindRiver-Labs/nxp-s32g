From 96a31d24f4012d8461cc806f326a97fe1ccf14d9 Mon Sep 17 00:00:00 2001
From: Larisa Grigore <larisa.grigore@nxp.com>
Date: Mon, 24 May 2021 09:50:51 +0300
Subject: [PATCH 05/10] spi: fsl-dspi: Restore slave pinmuxing after suspend

commit 8c1b14b9e595e123431018590072147cd4aca1ea from
https://source.codeaurora.org/external/autobsps32/linux

Upstream-Status: pending

Issue: ALB-7126
Signed-off-by: Larisa Grigore <larisa.grigore@nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 drivers/spi/spi-fsl-dspi.c | 25 ++++++++++++++++---------
 1 file changed, 16 insertions(+), 9 deletions(-)

diff --git a/drivers/spi/spi-fsl-dspi.c b/drivers/spi/spi-fsl-dspi.c
index c20cce466bf7..a81960e30ada 100644
--- a/drivers/spi/spi-fsl-dspi.c
+++ b/drivers/spi/spi-fsl-dspi.c
@@ -260,6 +260,9 @@ struct fsl_dspi {
 	int					pushr_cmd;
 	int					pushr_tx;
 
+        struct pinctrl                          *pinctrl_dspi;
+        struct pinctrl_state                    *pinctrl_slave;
+
 	void (*host_to_dev)(struct fsl_dspi *dspi, u32 *txdata);
 	void (*dev_to_host)(struct fsl_dspi *dspi, u32 rxdata);
 };
@@ -1162,7 +1165,11 @@ static int dspi_resume(struct device *dev)
 	struct fsl_dspi *dspi = dev_get_drvdata(dev);
 	int ret;
 
-	pinctrl_pm_select_default_state(dev);
+	if (dspi->ctlr->slave)
+		pinctrl_select_state(dspi->pinctrl_dspi,
+			dspi->pinctrl_slave);
+	else
+		pinctrl_pm_select_default_state(dev);
 
 	ret = clk_prepare_enable(dspi->clk);
 	if (ret)
@@ -1325,8 +1332,6 @@ static int dspi_probe(struct platform_device *pdev)
 	void __iomem *base;
 	u32 fifo_size;
 	bool big_endian;
-	struct pinctrl_state *pinctrl_slave;
-	struct pinctrl *pinctrl_dspi;
 	bool is_s32_dspi = false;
 
 	dspi = devm_kzalloc(&pdev->dev, sizeof(*dspi), GFP_KERNEL);
@@ -1454,16 +1459,18 @@ static int dspi_probe(struct platform_device *pdev)
 	}
 
 	if (ctlr->slave) {
-		pinctrl_dspi = devm_pinctrl_get(&pdev->dev);
-		if (IS_ERR(pinctrl_dspi)) {
+		dspi->pinctrl_dspi = devm_pinctrl_get(&pdev->dev);
+		if (IS_ERR(dspi->pinctrl_dspi)) {
 			dev_warn(&pdev->dev,
 				"no pinctrl info found: %ld\n",
-				PTR_ERR(pinctrl_dspi));
+				PTR_ERR(dspi->pinctrl_dspi));
 			goto out_pinctrl;
 		}
-		pinctrl_slave = pinctrl_lookup_state(pinctrl_dspi, "slave");
-		if (!IS_ERR(pinctrl_slave)) {
-			ret = pinctrl_select_state(pinctrl_dspi, pinctrl_slave);
+		dspi->pinctrl_slave = pinctrl_lookup_state(dspi->pinctrl_dspi,
+							   "slave");
+		if (!IS_ERR(dspi->pinctrl_slave)) {
+			ret = pinctrl_select_state(dspi->pinctrl_dspi,
+						   dspi->pinctrl_slave);
 			if (ret < 0)
 				dev_err(&pdev->dev,
 					"failed to switch to slave pinctrl: %d\n",
-- 
2.25.1

