From 0aba801153aad355b7cda6a2af59d859220ad1d9 Mon Sep 17 00:00:00 2001
From: Andra-Teodora Ilie <andra.ilie@nxp.com>
Date: Tue, 23 Nov 2021 17:31:44 +0200
Subject: [PATCH 24/50] s32r: bl2: Implement bl2_el3_early_platform_setup

Issue: ALB-7411
Upstream-Status: Pending 

Signed-off-by: Andra-Teodora Ilie <andra.ilie@nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 plat/nxp/s32/s32r/include/platform_def.h |  2 ++
 plat/nxp/s32/s32r/platform.mk            |  2 ++
 plat/nxp/s32/s32r/s32r_bl2_el3.c         | 30 ++++++++++++++++--------
 3 files changed, 24 insertions(+), 10 deletions(-)

diff --git a/plat/nxp/s32/s32r/include/platform_def.h b/plat/nxp/s32/s32r/include/platform_def.h
index 7870386de..c15f3ae2c 100644
--- a/plat/nxp/s32/s32r/include/platform_def.h
+++ b/plat/nxp/s32/s32r/include/platform_def.h
@@ -30,6 +30,8 @@
 #define FIRMWARE_WELCOME_STR_S32R_BL31	"This is S32R BL31\n"
 #endif
 
+#define S32_MAX_I2C_MODULES 3
+
 /* Off-Chasis */
 #define SIUL2_1_BASE_ADDR	0x4403C000UL
 
diff --git a/plat/nxp/s32/s32r/platform.mk b/plat/nxp/s32/s32r/platform.mk
index 6af170d3d..49932e8e9 100644
--- a/plat/nxp/s32/s32r/platform.mk
+++ b/plat/nxp/s32/s32r/platform.mk
@@ -10,6 +10,8 @@ PLAT_INCLUDES	+=	-Iplat/nxp/s32/s32r/include \
 					-Iplat/nxp/s32/include \
 
 PLAT_BL_COMMON_SOURCES += drivers/nxp/s32/clk/s32r45_clk.c \
+		plat/nxp/s32/s32gen1_mc_me.c \
+		plat/nxp/s32/s32gen1_mc_rgm.c \
 		plat/nxp/s32/s32gen1_sramc.c \
 
 BL2_SOURCES 	+=  \
diff --git a/plat/nxp/s32/s32r/s32r_bl2_el3.c b/plat/nxp/s32/s32r/s32r_bl2_el3.c
index 6f22dc904..591528aa4 100644
--- a/plat/nxp/s32/s32r/s32r_bl2_el3.c
+++ b/plat/nxp/s32/s32r/s32r_bl2_el3.c
@@ -5,26 +5,36 @@
  */
 #include <common/desc_image_load.h>
 #include <lib/libc/errno.h>
+#include "s32_bl_common.h"
+#include "s32_bl2_el3.h"
+#include "s32_linflexuart.h"
+#include "s32_storage.h"
 
-static bl_mem_params_node_t s32r_bl2_mem_params_descs[2];
+static bl_mem_params_node_t s32r_bl2_mem_params_descs[6];
 REGISTER_BL_IMAGE_DESCS(s32r_bl2_mem_params_descs)
 
-
 void bl2_el3_early_platform_setup(u_register_t arg0, u_register_t arg1,
 				  u_register_t arg2, u_register_t arg3)
 {
-	__asm__ volatile("b .");
-}
+	size_t index = 0;
+	bl_mem_params_node_t *params = s32r_bl2_mem_params_descs;
 
-void bl2_el3_plat_arch_setup(void)
-{
-	__asm__ volatile("b .");
+	s32_early_plat_init(false);
+	console_s32_register();
+	s32_io_setup();
+
+	add_fip_img_to_mem_params_descs(params, &index);
+	add_bl31_img_to_mem_params_descs(params, &index);
+	add_bl32_img_to_mem_params_descs(params, &index);
+	add_bl32_extra1_img_to_mem_params_descs(params, &index);
+	add_bl33_img_to_mem_params_descs(params, &index);
+	add_invalid_img_to_mem_params_descs(params, &index);
+
+	bl_mem_params_desc_num = index;
 }
 
-int plat_get_image_source(unsigned int image_id, uintptr_t *dev_handle,
-			  uintptr_t *image_spec)
+void bl2_el3_plat_arch_setup(void)
 {
 	__asm__ volatile("b .");
-	return -EINVAL;
 }
 
-- 
2.17.1

