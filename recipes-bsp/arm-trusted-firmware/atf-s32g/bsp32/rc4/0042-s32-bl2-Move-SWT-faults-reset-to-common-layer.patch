From f29f4cebb3c1617f0ee8045898e3de838ddfd9f7 Mon Sep 17 00:00:00 2001
From: Andra-Teodora Ilie <andra.ilie@nxp.com>
Date: Tue, 18 Jan 2022 10:59:36 +0200
Subject: [PATCH 42/50] s32: bl2: Move SWT faults reset to common layer

Issue: ALB-7411
Upstream-Status: Pending 

Signed-off-by: Andra-Teodora Ilie <andra.ilie@nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 plat/nxp/s32/include/s32_bl2_el3.h |  1 +
 plat/nxp/s32/s32_bl2_el3.c         | 20 ++++++++++++++++++++
 plat/nxp/s32/s32g/s32g_bl2_el3.c   | 20 --------------------
 plat/nxp/s32/s32r/s32r_bl2_el3.c   |  2 ++
 4 files changed, 23 insertions(+), 20 deletions(-)

diff --git a/plat/nxp/s32/include/s32_bl2_el3.h b/plat/nxp/s32/include/s32_bl2_el3.h
index 1bc2f66a0..4c7e25460 100644
--- a/plat/nxp/s32/include/s32_bl2_el3.h
+++ b/plat/nxp/s32/include/s32_bl2_el3.h
@@ -16,5 +16,6 @@ void add_bl33_img_to_mem_params_descs(bl_mem_params_node_t *params, size_t *inde
 void add_invalid_img_to_mem_params_descs(bl_mem_params_node_t *params, size_t *index);
 
 int s32_el3_mmu_fixup(void);
+void clear_swt_faults(void);
 
 #endif /* S32_BL2_EL3_H */
diff --git a/plat/nxp/s32/s32_bl2_el3.c b/plat/nxp/s32/s32_bl2_el3.c
index 16502e723..900859a70 100644
--- a/plat/nxp/s32/s32_bl2_el3.c
+++ b/plat/nxp/s32/s32_bl2_el3.c
@@ -31,6 +31,12 @@
 #define AARCH64_UNCOND_BRANCH_OP	(BIT(26) | BIT(28))
 #define BL33_DTB_MAGIC				(0xedfe0dd0)
 
+#define PER_GROUP3_BASE		(0x40300000UL)
+#define FCCU_BASE_ADDR		(PER_GROUP3_BASE + 0x0000C000)
+#define FCCU_NCF_S1			(FCCU_BASE_ADDR + 0x84)
+#define FCCU_NCFK			(FCCU_BASE_ADDR + 0x90)
+#define FCCU_NCFK_KEY		(0xAB3498FE)
+
 void add_fip_img_to_mem_params_descs(bl_mem_params_node_t *params,
 					    size_t *index)
 {
@@ -577,3 +583,17 @@ int bl2_plat_handle_post_image_load(unsigned int image_id)
 	return 0;
 }
 
+/**
+ * Clear non-critical faults generated by SWT (software watchdog timer)
+ * All SWT faults are placed in NCF_S1 (33-38)
+ */
+void clear_swt_faults(void)
+{
+	unsigned int val = mmio_read_32(FCCU_NCF_S1);
+
+	if (val) {
+		mmio_write_32(FCCU_NCFK, FCCU_NCFK_KEY);
+		mmio_write_32(FCCU_NCF_S1, val);
+	}
+}
+
diff --git a/plat/nxp/s32/s32g/s32g_bl2_el3.c b/plat/nxp/s32/s32g/s32g_bl2_el3.c
index cc338498c..c48c7b809 100644
--- a/plat/nxp/s32/s32g/s32g_bl2_el3.c
+++ b/plat/nxp/s32/s32g/s32g_bl2_el3.c
@@ -22,29 +22,9 @@
 #include <drivers/nxp/s32/ddr/ddr_lp.h>
 #endif
 
-#define PER_GROUP3_BASE		(0x40300000UL)
-#define FCCU_BASE_ADDR		(PER_GROUP3_BASE + 0x0000C000)
-#define FCCU_NCF_S1			(FCCU_BASE_ADDR + 0x84)
-#define FCCU_NCFK			(FCCU_BASE_ADDR + 0x90)
-#define FCCU_NCFK_KEY		(0xAB3498FE)
-
 static bl_mem_params_node_t s32g_bl2_mem_params_descs[6];
 REGISTER_BL_IMAGE_DESCS(s32g_bl2_mem_params_descs)
 
-/**
- * Clear non-critical faults generated by SWT (software watchdog timer)
- * All SWT faults are placed in NCF_S1 (33-38)
- */
-static void clear_swt_faults(void)
-{
-	unsigned int val = mmio_read_32(FCCU_NCF_S1);
-
-	if (val) {
-		mmio_write_32(FCCU_NCFK, FCCU_NCFK_KEY);
-		mmio_write_32(FCCU_NCF_S1, val);
-	}
-}
-
 static void clear_reset_cause(void)
 {
 	uint32_t mc_rgm_des = mmio_read_32(MC_RGM_DES);
diff --git a/plat/nxp/s32/s32r/s32r_bl2_el3.c b/plat/nxp/s32/s32r/s32r_bl2_el3.c
index b28ac63de..ad430bf91 100644
--- a/plat/nxp/s32/s32r/s32r_bl2_el3.c
+++ b/plat/nxp/s32/s32r/s32r_bl2_el3.c
@@ -52,6 +52,8 @@ void bl2_el3_plat_arch_setup(void)
 	 */
 	s32_sram_clear(FIP_BASE, FIP_BASE + FIP_HEADER_SIZE);
 
+	clear_swt_faults();
+
 	ret = ddr_init();
 	if (ret)
 		panic();
-- 
2.17.1

