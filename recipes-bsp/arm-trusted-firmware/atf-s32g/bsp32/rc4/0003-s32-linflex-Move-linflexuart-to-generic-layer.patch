From 360fcd7d1055e5ea127f9782ff537e2998f8b052 Mon Sep 17 00:00:00 2001
From: Andra-Teodora Ilie <andra.ilie@nxp.com>
Date: Fri, 26 Nov 2021 11:30:24 +0200
Subject: [PATCH 03/50] s32: linflex: Move linflexuart to generic layer

Issue: ALB-7411
Upstream-Status: Pending 

Signed-off-by: Andra-Teodora Ilie <andra.ilie@nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 .../s32_linflexuart.h}                        |  6 +++---
 plat/nxp/s32/include/s32_platform_def.h       | 15 ++++++++++++++-
 plat/nxp/s32/s32_common.mk                    | 13 +++++++++++++
 .../s32g_linflexuart.c => s32_linflexuart.c}  | 18 +++++++++---------
 ...exuart_crash.S => s32_linflexuart_crash.S} |  4 ++--
 plat/nxp/s32/s32g/bl31_sram/bl31_sram.mk      |  2 --
 plat/nxp/s32/s32g/bl31_ssram/bl31_ssram.mk    |  2 --
 plat/nxp/s32/s32g/include/s32g_platform_def.h | 13 -------------
 plat/nxp/s32/s32g/s32g_bl2_el3.c              |  6 +++---
 plat/nxp/s32/s32g/s32g_bl31.c                 |  8 ++++----
 plat/nxp/s32/s32g/s32g_common.mk              | 19 ++++---------------
 plat/nxp/s32/s32g/s32g_pinctrl.c              |  2 +-
 plat/nxp/s32/s32g/s32g_resume.c               |  6 +++---
 13 files changed, 56 insertions(+), 58 deletions(-)
 rename plat/nxp/s32/{s32g/include/s32g_linflexuart.h => include/s32_linflexuart.h} (50%)
 rename plat/nxp/s32/{s32g/s32g_linflexuart.c => s32_linflexuart.c} (62%)
 rename plat/nxp/s32/{s32g/s32g_linflexuart_crash.S => s32_linflexuart_crash.S} (89%)

diff --git a/plat/nxp/s32/s32g/include/s32g_linflexuart.h b/plat/nxp/s32/include/s32_linflexuart.h
similarity index 50%
rename from plat/nxp/s32/s32g/include/s32g_linflexuart.h
rename to plat/nxp/s32/include/s32_linflexuart.h
index 809455daf..9340bd553 100644
--- a/plat/nxp/s32/s32g/include/s32g_linflexuart.h
+++ b/plat/nxp/s32/include/s32_linflexuart.h
@@ -3,10 +3,10 @@
  *
  * SPDX-License-Identifier: BSD-3-Clause
  */
-#ifndef S32G_LINFLEXUART_H
-#define S32G_LINFLEXUART_H
+#ifndef S32_LINFLEXUART_H
+#define S32_LINFLEXUART_H
 
-int console_s32g_register(void);
+int console_s32_register(void);
 
 #endif
 
diff --git a/plat/nxp/s32/include/s32_platform_def.h b/plat/nxp/s32/include/s32_platform_def.h
index 0340f8a43..eb9fc405c 100644
--- a/plat/nxp/s32/include/s32_platform_def.h
+++ b/plat/nxp/s32/include/s32_platform_def.h
@@ -52,7 +52,7 @@
  * wear a helmet and compile with -Os.
  */
 #define BOOTROM_ADMA_RSRVD_BASE		(0x343ff000)
-#define BL2_LIMIT			(BOOTROM_ADMA_RSRVD_BASE - 1)
+#define BL2_LIMIT					(BOOTROM_ADMA_RSRVD_BASE - 1)
 
 /* U-boot addresses in SRAM. BL33_DTB and BL33_ENTRYPOINT must be kept in
  * sync with u-boot's CONFIG_DTB_SRAM_ADDR and CONFIG_SYS_TEXT_BASE.
@@ -88,5 +88,18 @@
 #define MAX_IO_HANDLES			4
 #define MAX_IO_DEVICES			3
 
+#define S32_LINFLEX0_BASE	(0x401C8000ul)
+#define S32_LINFLEX0_SIZE	(0x4000)
+#define S32_LINFLEX1_BASE	(0x401CC000ul)
+#define S32_LINFLEX1_SIZE	(0x4000)
+
+#if S32G_EMU == 1
+#define S32_UART_BASE		S32_LINFLEX1_BASE
+#define S32_UART_SIZE		S32_LINFLEX1_SIZE
+#else
+#define S32_UART_BASE		S32_LINFLEX0_BASE
+#define S32_UART_SIZE		S32_LINFLEX0_SIZE
+#endif
+
 #endif /* S32_PLATFORM_H */
 
diff --git a/plat/nxp/s32/s32_common.mk b/plat/nxp/s32/s32_common.mk
index 51baba58e..f48aca3f7 100644
--- a/plat/nxp/s32/s32_common.mk
+++ b/plat/nxp/s32/s32_common.mk
@@ -19,6 +19,9 @@ ERRATA_SPECULATIVE_AT	:= 1
 HEXDUMP ?= xxd
 SED ?= sed
 
+S32G_EMU		?= 0
+$(eval $(call add_define_val,S32G_EMU,$(S32G_EMU)))
+
 BL2_AT_EL3		:= 1
 
 PLAT_INCLUDES 	+= \
@@ -42,6 +45,8 @@ PLAT_BL_COMMON_SOURCES += \
 			plat/nxp/s32/s32_lowlevel_common.S \
 			plat/nxp/s32/s32_sramc.c \
 			plat/nxp/s32/s32_sramc_asm.S \
+			plat/nxp/s32/s32_linflexuart.c \
+			plat/nxp/s32/s32_linflexuart_crash.S \
 
 BL2_SOURCES += \
 			${XLAT_TABLES_LIB_SRCS} \
@@ -101,6 +106,14 @@ CRASH_REPORTING		:= 1
 # As verbose as it can be
 LOG_LEVEL		?= 50
 
+# Sharing the LinFlexD UART is not always a safe option. Different drivers
+# (e.g. Linux and TF-A) can configure the UART controller differently; even so,
+# there is no hardware lock to prevent concurrent access to the device. For now,
+# opt to suppress output (except for crash reporting). For debugging and other
+# similarly safe contexts, output can be turned back on using this switch.
+S32_USE_LINFLEX_IN_BL31	?= 0
+$(eval $(call add_define_val,S32_USE_LINFLEX_IN_BL31,$(S32_USE_LINFLEX_IN_BL31)))
+
 # Reserve some space at the end of SRAM for external apps and include it
 # in the calculation of FIP_BASE address.
 EXT_APP_SIZE		:= 0x100000
diff --git a/plat/nxp/s32/s32g/s32g_linflexuart.c b/plat/nxp/s32/s32_linflexuart.c
similarity index 62%
rename from plat/nxp/s32/s32g/s32g_linflexuart.c
rename to plat/nxp/s32/s32_linflexuart.c
index 2abf60048..dfcbf14ec 100644
--- a/plat/nxp/s32/s32g/s32g_linflexuart.c
+++ b/plat/nxp/s32/s32_linflexuart.c
@@ -7,32 +7,32 @@
 #include <platform.h>
 #include <platform_def.h>
 
-#define S32G_UART_BAUDRATE	(115200)
-#define S32G_UART_CLOCK_HZ	(125000000)
+#define S32_UART_BAUDRATE	(115200)
+#define S32_UART_CLOCK_HZ	(125000000)
 
 static struct console_linflex console = {
-	.base = S32G_UART_BASE,
-	.clock = S32G_UART_CLOCK_HZ,
-	.baud = S32G_UART_BAUDRATE,
+	.base = S32_UART_BASE,
+	.clock = S32_UART_CLOCK_HZ,
+	.baud = S32_UART_BAUDRATE,
 	.console = {
 		.putc = console_linflex_putc,
 		.flush = console_linflex_flush,
 		.flags = CONSOLE_FLAG_BOOT | CONSOLE_FLAG_CRASH,
-		.base = S32G_UART_BASE,
+		.base = S32_UART_BASE,
 	},
 };
 
-int console_s32g_register(void)
+int console_s32_register(void)
 {
 	return console_linflex_register(&console);
 }
 
-int s32g_plat_crash_console_putc(int c)
+int s32_plat_crash_console_putc(int c)
 {
 	return console_linflex_putc(c, &console.console);
 }
 
-void s32g_plat_crash_console_flush(void)
+void s32_plat_crash_console_flush(void)
 {
 	return console_linflex_flush(&console.console);
 }
diff --git a/plat/nxp/s32/s32g/s32g_linflexuart_crash.S b/plat/nxp/s32/s32_linflexuart_crash.S
similarity index 89%
rename from plat/nxp/s32/s32g/s32g_linflexuart_crash.S
rename to plat/nxp/s32/s32_linflexuart_crash.S
index adb53c975..7332419be 100644
--- a/plat/nxp/s32/s32g/s32g_linflexuart_crash.S
+++ b/plat/nxp/s32/s32_linflexuart_crash.S
@@ -20,7 +20,7 @@ func plat_crash_console_putc
 	s32_save_regs
 	s32_init_local_stack
 
-	bl s32g_plat_crash_console_putc
+	bl s32_plat_crash_console_putc
 
 	s32_check_stack_guard
 	s32_restore_regs
@@ -31,7 +31,7 @@ func plat_crash_console_flush
 	s32_save_regs
 	s32_init_local_stack
 
-	bl s32g_plat_crash_console_flush
+	bl s32_plat_crash_console_flush
 
 	s32_check_stack_guard
 	s32_restore_regs
diff --git a/plat/nxp/s32/s32g/bl31_sram/bl31_sram.mk b/plat/nxp/s32/s32g/bl31_sram/bl31_sram.mk
index c25911ca2..81135bbed 100644
--- a/plat/nxp/s32/s32g/bl31_sram/bl31_sram.mk
+++ b/plat/nxp/s32/s32g/bl31_sram/bl31_sram.mk
@@ -10,8 +10,6 @@ BL31SRAM_SOURCES = plat/common/aarch64/platform_up_stack.S \
 		   plat/nxp/s32/s32g/s32g_clocks.c \
 		   plat/nxp/s32/s32g/s32g_lowlevel_common.S \
 		   plat/nxp/s32/s32g/s32g_mc_me.c \
-		   plat/nxp/s32/s32g/s32g_linflexuart.c \
-		   plat/nxp/s32/s32g/s32g_linflexuart_crash.S \
 		   ${DDR_DRV}/ddr_lp_mmio.c \
 
 BL31SRAM_ARRAY_NAME ?= bl31sram
diff --git a/plat/nxp/s32/s32g/bl31_ssram/bl31_ssram.mk b/plat/nxp/s32/s32g/bl31_ssram/bl31_ssram.mk
index 43ad216ea..03c156635 100644
--- a/plat/nxp/s32/s32g/bl31_ssram/bl31_ssram.mk
+++ b/plat/nxp/s32/s32g/bl31_ssram/bl31_ssram.mk
@@ -11,8 +11,6 @@ BL31SSRAM_SOURCES =  plat/nxp/s32/s32g/bl31_ssram/bl31ssram_stacks.S \
 		     plat/nxp/s32/s32g/s32g_clocks.c \
 		     plat/nxp/s32/s32g/s32g_lowlevel_common.S \
 		     plat/nxp/s32/s32g/s32g_mc_me.c \
-		     plat/nxp/s32/s32g/s32g_linflexuart.c \
-		     plat/nxp/s32/s32g/s32g_linflexuart_crash.S \
 		     ${DDR_DRV_SRCS} \
 		     ${LIBC_SRCS}
 
diff --git a/plat/nxp/s32/s32g/include/s32g_platform_def.h b/plat/nxp/s32/s32g/include/s32g_platform_def.h
index 8179c3b86..baa289bbd 100644
--- a/plat/nxp/s32/s32g/include/s32g_platform_def.h
+++ b/plat/nxp/s32/s32g/include/s32g_platform_def.h
@@ -136,19 +136,6 @@
 #pragma warning "BL33 image is being built; you should configure it out."
 #endif
 
-#define S32G_LINFLEX0_BASE	(0x401C8000ul)
-#define S32G_LINFLEX0_SIZE	(0x4000)
-#define S32G_LINFLEX1_BASE	(0x401CC000ul)
-#define S32G_LINFLEX1_SIZE	(0x4000)
-
-#if S32G_EMU == 1
-#define S32G_UART_BASE		S32G_LINFLEX1_BASE
-#define S32G_UART_SIZE		S32G_LINFLEX1_SIZE
-#else
-#define S32G_UART_BASE		S32G_LINFLEX0_BASE
-#define S32G_UART_SIZE		S32G_LINFLEX0_SIZE
-#endif
-
 #define S32G_SCMI_SHARED_MEM		0xd0000000U
 #define S32G_SCMI_SHARED_MEM_SIZE	0x400000U
 
diff --git a/plat/nxp/s32/s32g/s32g_bl2_el3.c b/plat/nxp/s32/s32g/s32g_bl2_el3.c
index c04f4fcc2..cdcee17f5 100644
--- a/plat/nxp/s32/s32g/s32g_bl2_el3.c
+++ b/plat/nxp/s32/s32g/s32g_bl2_el3.c
@@ -16,7 +16,7 @@
 #include <lib/optee_utils.h>
 #include <lib/xlat_tables/xlat_tables_v2.h>
 #include "s32g_clocks.h"
-#include "s32g_linflexuart.h"
+#include "s32_linflexuart.h"
 #include "s32g_storage.h"
 #include "s32g_mc_rgm.h"
 #include "s32g_mc_me.h"
@@ -532,7 +532,7 @@ IMPORT_SYM(uintptr_t, __RW_START__, BL2_RW_START);
 static mmap_region_t s32g_mmap[] = {
 	MAP_REGION_FLAT(S32G_SSRAM_BASE, S32G_SSRAM_LIMIT - S32G_SSRAM_BASE,
 			 MT_MEMORY | MT_RW | MT_SECURE),
-	MAP_REGION_FLAT(S32G_UART_BASE, S32G_UART_SIZE,
+	MAP_REGION_FLAT(S32_UART_BASE, S32_UART_SIZE,
 			MT_DEVICE | MT_RW | MT_NS),
 	MAP_REGION_FLAT(S32G_MC_ME_BASE_ADDR, S32G_MC_ME_SIZE,
 			MT_DEVICE | MT_RW),
@@ -695,7 +695,7 @@ void bl2_el3_early_platform_setup(u_register_t arg0, u_register_t arg1,
 #endif
 
 	s32g_early_plat_init(false);
-	console_s32g_register();
+	console_s32_register();
 	s32g_io_setup();
 
 	NOTICE("Reset status: %s\n", get_reset_cause_str(reset_cause));
diff --git a/plat/nxp/s32/s32g/s32g_bl31.c b/plat/nxp/s32/s32g/s32g_bl31.c
index caf74663f..a9029b49e 100644
--- a/plat/nxp/s32/s32g/s32g_bl31.c
+++ b/plat/nxp/s32/s32g/s32g_bl31.c
@@ -20,7 +20,7 @@
 #include "s32g_pm.h"
 #include "s32g_clocks.h"
 #include "s32g_dt.h"
-#include "s32g_linflexuart.h"
+#include "s32_linflexuart.h"
 #include "s32g_lowlevel.h"
 #include "s32g_mc_me.h"
 #include "s32g_mc_rgm.h"
@@ -42,7 +42,7 @@ static gicv3_dist_ctx_t dist_ctx;
 static const mmap_region_t s32g_mmap[] = {
 	MAP_REGION_FLAT(S32G_SSRAM_BASE, S32G_SSRAM_LIMIT - S32G_SSRAM_BASE,
 			 MT_MEMORY | MT_RW | MT_SECURE),
-	MAP_REGION_FLAT(S32G_UART_BASE, S32G_UART_SIZE,
+	MAP_REGION_FLAT(S32_UART_BASE, S32_UART_SIZE,
 			MT_DEVICE | MT_RW | MT_NS),
 	MAP_REGION_FLAT(S32G274A_GIC_BASE, S32G274A_GIC_SIZE,
 			MT_DEVICE | MT_RW),
@@ -301,8 +301,8 @@ void bl31_plat_arch_setup(void)
 	s32g_smp_fixup();
 	s32g_el3_mmu_fixup();
 
-#if (S32G_USE_LINFLEX_IN_BL31 == 1)
-	console_s32g_register();
+#if (S32_USE_LINFLEX_IN_BL31 == 1)
+	console_s32_register();
 #endif
 }
 
diff --git a/plat/nxp/s32/s32g/s32g_common.mk b/plat/nxp/s32/s32g/s32g_common.mk
index a728ebc89..c284da0ce 100644
--- a/plat/nxp/s32/s32g/s32g_common.mk
+++ b/plat/nxp/s32/s32g/s32g_common.mk
@@ -6,9 +6,6 @@
 
 include plat/nxp/s32/s32_common.mk
 
-S32G_EMU		?= 0
-$(eval $(call add_define_val,S32G_EMU,$(S32G_EMU)))
-
 S32G_DRAM_INLINE_ECC	?= 1
 $(eval $(call add_define_val,S32G_DRAM_INLINE_ECC,$(S32G_DRAM_INLINE_ECC)))
 
@@ -47,8 +44,6 @@ PLAT_BL_COMMON_SOURCES	+= plat/nxp/s32/s32g/s32g_lowlevel_common.S \
 			   plat/nxp/s32/s32g/s32g_dt.c \
 			   plat/nxp/s32/s32g/s32g_pinctrl.c \
 			   plat/nxp/s32/s32g/s32g_clocks.c \
-			   plat/nxp/s32/s32g/s32g_linflexuart.c \
-			   plat/nxp/s32/s32g/s32g_linflexuart_crash.S \
 			   drivers/nxp/s32g/i2c/s32g_i2c.c \
 			   drivers/delay_timer/delay_timer.c \
 			   drivers/delay_timer/generic_delay_timer.c \
@@ -119,18 +114,12 @@ endif
 ### Platform-specific defines ###
 # Which LinFlexD to use as a UART device
 ifeq ($(S32G_EMU),0)
-S32G_LINFLEX_MODULE	:= 0
+S32_LINFLEX_MODULE	:= 0
 else
-S32G_LINFLEX_MODULE	:= 1
+S32_LINFLEX_MODULE	:= 1
 endif
-$(eval $(call add_define_val,S32G_LINFLEX_MODULE,$(S32G_LINFLEX_MODULE)))
-# Sharing the LinFlexD UART is not always a safe option. Different drivers
-# (e.g. Linux and TF-A) can configure the UART controller differently; even so,
-# there is no hardware lock to prevent concurrent access to the device. For now,
-# opt to suppress output (except for crash reporting). For debugging and other
-# similarly safe contexts, output can be turned back on using this switch.
-S32G_USE_LINFLEX_IN_BL31	?= 0
-$(eval $(call add_define_val,S32G_USE_LINFLEX_IN_BL31,$(S32G_USE_LINFLEX_IN_BL31)))
+$(eval $(call add_define_val,S32_LINFLEX_MODULE,$(S32_LINFLEX_MODULE)))
+
 # Whether we're going to run a hypervisor (EL2) or jump straight into the
 # bootloader (EL1)
 S32G_HAS_HV		?= 0
diff --git a/plat/nxp/s32/s32g/s32g_pinctrl.c b/plat/nxp/s32/s32g/s32g_pinctrl.c
index 399d998a3..21dfc8956 100644
--- a/plat/nxp/s32/s32g/s32g_pinctrl.c
+++ b/plat/nxp/s32/s32g/s32g_pinctrl.c
@@ -189,6 +189,6 @@ void i2c_config_pinctrl(void)
 
 void s32g_plat_config_pinctrl(void)
 {
-	linflex_config_pinctrl(S32G_LINFLEX_MODULE);
+	linflex_config_pinctrl(S32_LINFLEX_MODULE);
 	sdhc_config_pinctrl();
 }
diff --git a/plat/nxp/s32/s32g/s32g_resume.c b/plat/nxp/s32/s32g/s32g_resume.c
index ccaccf545..92204f590 100644
--- a/plat/nxp/s32/s32g/s32g_resume.c
+++ b/plat/nxp/s32/s32g/s32g_resume.c
@@ -4,7 +4,7 @@
  * SPDX-License-Identifier: BSD-3-Clause
  */
 #include "s32g_bl_common.h"
-#include "s32g_linflexuart.h"
+#include "s32_linflexuart.h"
 #include "s32g_lowlevel.h"
 #include "s32g_resume.h"
 #include "s32gen1-wkpu.h"
@@ -45,8 +45,8 @@ void s32g_resume_entrypoint(void)
 	reset_rtc();
 	s32gen1_wkpu_reset();
 
-#if (S32G_USE_LINFLEX_IN_BL31 == 1)
-	console_s32g_register();
+#if (S32_USE_LINFLEX_IN_BL31 == 1)
+	console_s32_register();
 #endif
 	plat_gic_restore();
 	bl31_warm_entrypoint();
-- 
2.17.1

