From b0655e32ef26f879dfdd289b507721b5c0d6ce44 Mon Sep 17 00:00:00 2001
From: Andra-Teodora Ilie <andra.ilie@nxp.com>
Date: Wed, 24 Nov 2021 16:35:44 +0200
Subject: [PATCH 28/50] s32r: bl2: Implement bl2_el3_plat_arch_setup

Issue: ALB-7411
Upstream-Status: Pending 

Signed-off-by: Andra-Teodora Ilie <andra.ilie@nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 plat/nxp/s32/s32r/include/platform_def.h | 17 ++++++++++++++---
 plat/nxp/s32/s32r/s32r_bl2_el3.c         | 21 ++++++++++++++++++++-
 2 files changed, 34 insertions(+), 4 deletions(-)

diff --git a/plat/nxp/s32/s32r/include/platform_def.h b/plat/nxp/s32/s32r/include/platform_def.h
index c15f3ae2c..4c4ec65fc 100644
--- a/plat/nxp/s32/s32r/include/platform_def.h
+++ b/plat/nxp/s32/s32r/include/platform_def.h
@@ -14,9 +14,20 @@
 #define S32_MPIDR_CPU_MASK		0x1
 #define S32_MPIDR_CPU_MASK_BITS	0x1
 
-/* FIXME - might be common for G&R */
-#define MAX_MMAP_REGIONS		8
-#define MAX_XLAT_TABLES			4
+#if defined IMAGE_BL31
+/* To limit usage, keep these in sync with sizeof(s32_mmap) */
+#define MAX_MMAP_REGIONS		13
+#define MAX_XLAT_TABLES			13
+#endif
+
+#if defined IMAGE_BL2
+#define MAX_MMAP_REGIONS		15
+#define MAX_XLAT_TABLES			25
+#endif
+
+#if defined IMAGE_BL33
+#pragma warning "BL33 image is being built; you should configure it out."
+#endif
 
 #define S32_SRAM_SIZE		0x00800000
 
diff --git a/plat/nxp/s32/s32r/s32r_bl2_el3.c b/plat/nxp/s32/s32r/s32r_bl2_el3.c
index 591528aa4..b28ac63de 100644
--- a/plat/nxp/s32/s32r/s32r_bl2_el3.c
+++ b/plat/nxp/s32/s32r/s32r_bl2_el3.c
@@ -3,12 +3,16 @@
  *
  * SPDX-License-Identifier: BSD-3-Clause
  */
+
 #include <common/desc_image_load.h>
+#include <ddr/ddr_init.h>
 #include <lib/libc/errno.h>
+#include "platform_def.h"
 #include "s32_bl_common.h"
 #include "s32_bl2_el3.h"
 #include "s32_linflexuart.h"
 #include "s32_storage.h"
+#include "s32_sramc.h"
 
 static bl_mem_params_node_t s32r_bl2_mem_params_descs[6];
 REGISTER_BL_IMAGE_DESCS(s32r_bl2_mem_params_descs)
@@ -35,6 +39,21 @@ void bl2_el3_early_platform_setup(u_register_t arg0, u_register_t arg1,
 
 void bl2_el3_plat_arch_setup(void)
 {
-	__asm__ volatile("b .");
+	uint32_t ret;
+
+	ret = s32_el3_mmu_fixup();
+	if (ret)
+		panic();
+
+	s32_sram_clear(S32_BL33_IMAGE_BASE, DTB_BASE);
+	/* Clear only the necessary part for the FIP header. The rest will
+	 * be cleared in bl2_plat_handle_post_image_load, before loading
+	 * the entire FIP image.
+	 */
+	s32_sram_clear(FIP_BASE, FIP_BASE + FIP_HEADER_SIZE);
+
+	ret = ddr_init();
+	if (ret)
+		panic();
 }
 
-- 
2.17.1

