From e511dc1bff50d4808d7372ca41bc3f686cbf8d0d Mon Sep 17 00:00:00 2001
From: Ghennadi Procopciuc <ghennadi.procopciuc@nxp.com>
Date: Mon, 31 Jan 2022 11:45:52 +0200
Subject: [PATCH 05/11] s32g: Use PAGE_SIZE for MMU entries alignment

Issue: ALB-8434
Upstream-Status: Pending 

Signed-off-by: Ghennadi Procopciuc <ghennadi.procopciuc@nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 plat/nxp/s32/s32_bl2_el3.c | 23 +++++++++++++----------
 1 file changed, 13 insertions(+), 10 deletions(-)

diff --git a/plat/nxp/s32/s32_bl2_el3.c b/plat/nxp/s32/s32_bl2_el3.c
index f124e20bd..af9d727f3 100644
--- a/plat/nxp/s32/s32_bl2_el3.c
+++ b/plat/nxp/s32/s32_bl2_el3.c
@@ -173,8 +173,10 @@ void add_invalid_img_to_mem_params_descs(bl_mem_params_node_t *params,
 	params[(*index)++] = node;
 }
 
-#define MMU_ROUND_UP_TO_4K(x)	\
-			(((x) & ~0xfff) == (x) ? (x) : ((x) & ~0xfff) + 0x1000)
+#define PAGE_MASK		(PAGE_SIZE_4KB - 1)
+#define MMU_ROUND_UP_TO_PAGE(x)	(((x) & ~PAGE_MASK) == (x) ? \
+				 (x) : \
+				 ((x) & ~PAGE_MASK) + PAGE_SIZE_4KB)
 
 IMPORT_SYM(uintptr_t, __RW_START__, BL2_RW_START);
 
@@ -188,7 +190,7 @@ static mmap_region_t s32_mmap[] = {
 	MAP_REGION_FLAT(S32_MC_ME_BASE_ADDR, S32_MC_ME_SIZE,
 			MT_DEVICE | MT_RW),
 	MAP_REGION_FLAT(MC_CGM0_BASE_ADDR,
-			MMU_ROUND_UP_TO_4K(S32_DFS_ADDR(S32_DFS_NR)),
+			MMU_ROUND_UP_TO_PAGE(S32_DFS_ADDR(S32_DFS_NR)),
 			MT_DEVICE | MT_RW),
 	/* This will cover both the MC_RGM and the GPR accesses, while reducing
 	 * the number of used up MMU regions.
@@ -202,10 +204,10 @@ static mmap_region_t s32_mmap[] = {
 			MT_DEVICE | MT_RW),
 #endif
 	MAP_REGION2(S32_BL32_BASE, S32_BL32_BASE,
-			MMU_ROUND_UP_TO_4K(S32_BL32_SIZE),
+			MMU_ROUND_UP_TO_PAGE(S32_BL32_SIZE),
 			MT_MEMORY | MT_RW, PAGE_SIZE),
 	MAP_REGION2(S32_BL33_IMAGE_BASE, S32_BL33_IMAGE_BASE,
-			MMU_ROUND_UP_TO_4K(S32_BL33_IMAGE_SIZE),
+			MMU_ROUND_UP_TO_PAGE(S32_BL33_IMAGE_SIZE),
 			MT_MEMORY | MT_RW, PAGE_SIZE),
 	MAP_REGION_FLAT(S32_PMEM_START, S32_PMEM_LEN,
 			MT_MEMORY | MT_RW | MT_SECURE),
@@ -506,15 +508,16 @@ int bl2_plat_handle_post_image_load(unsigned int image_id)
 	if (image_id == BL33_IMAGE_ID) {
 		magic = mmio_read_32(BL33_ENTRYPOINT);
 		if (!is_branch_op(magic)) {
-			printf("Warning: Instruction at BL33_ENTRYPOINT");
-			printf(" is 0x%x, which is not a B or BL!\n", magic);
+			printf(
+			    "Warning: Instruction at BL33_ENTRYPOINT (0x%x) is 0x%x, which is not a B or BL!\n",
+			    BL33_ENTRYPOINT, magic);
 		}
 
 		magic = mmio_read_32(BL33_DTB);
 		if (magic != BL33_DTB_MAGIC) {
-			printf("Error: Instruction at BL33_DTB is 0x%x", magic);
-			printf(", which is not the expected 0x%x!\n",
-			       BL33_DTB_MAGIC);
+			printf(
+			    "Error: Instruction at BL33_DTB(0x%x) is 0x%x, which is not the expected 0x%x!\n",
+			    BL33_DTB, magic, BL33_DTB_MAGIC);
 			return -EINVAL;
 		}
 
-- 
2.17.1

