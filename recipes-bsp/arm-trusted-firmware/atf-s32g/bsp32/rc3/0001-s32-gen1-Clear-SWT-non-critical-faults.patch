From f40bafc7a62be12bd1fcd5801f5588ea7e36abf8 Mon Sep 17 00:00:00 2001
From: Ciprian Costea <ciprianmarian.costea@nxp.com>
Date: Wed, 12 Jan 2022 15:38:01 +0200
Subject: [PATCH 1/6] s32-gen1: Clear SWT non-critical faults

Issue: ALB-8341
Upstream-Status: Pending 

Signed-off-by: Ciprian Costea <ciprianmarian.costea@nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 plat/nxp/s32/s32g/s32g_bl2_el3.c | 24 +++++++++++++++++++++++-
 1 file changed, 23 insertions(+), 1 deletion(-)

diff --git a/plat/nxp/s32/s32g/s32g_bl2_el3.c b/plat/nxp/s32/s32g/s32g_bl2_el3.c
index 19c122004..9340df7cf 100644
--- a/plat/nxp/s32/s32g/s32g_bl2_el3.c
+++ b/plat/nxp/s32/s32g/s32g_bl2_el3.c
@@ -1,5 +1,5 @@
 /*
- * Copyright 2019-2021 NXP
+ * Copyright 2019-2022 NXP
  *
  * SPDX-License-Identifier: BSD-3-Clause
  */
@@ -44,6 +44,12 @@
 #define AARCH64_UNCOND_BRANCH_OP	(BIT(26) | BIT(28))
 #define BL33_DTB_MAGIC			(0xedfe0dd0)
 
+#define PER_GROUP3_BASE		(0x40300000UL)
+#define FCCU_BASE_ADDR		(PER_GROUP3_BASE + 0x0000C000)
+#define FCCU_NCF_S1			(FCCU_BASE_ADDR + 0x84)
+#define FCCU_NCFK			(FCCU_BASE_ADDR + 0x90)
+#define FCCU_NCFK_KEY		(0xAB3498FE)
+
 static bl_mem_params_node_t s32g_bl2_mem_params_descs[6];
 REGISTER_BL_IMAGE_DESCS(s32g_bl2_mem_params_descs)
 
@@ -455,6 +461,20 @@ int bl2_plat_handle_post_image_load(unsigned int image_id)
 	return 0;
 }
 
+/**
+ * Clear non-critical faults generated by SWT (software watchdog timer)
+ * All SWT faults are placed in NCF_S1 (33-38)
+ */
+static void clear_swt_faults(void)
+{
+	unsigned int val = mmio_read_32(FCCU_NCF_S1);
+
+	if (val) {
+		mmio_write_32(FCCU_NCFK, FCCU_NCFK_KEY);
+		mmio_write_32(FCCU_NCF_S1, val);
+	}
+}
+
 enum reset_cause get_reset_cause(void)
 {
 	uint32_t mc_rgm_des = mmio_read_32(MC_RGM_DES);
@@ -716,6 +736,8 @@ void bl2_el3_plat_arch_setup(void)
 	s32_ssram_clear();
 
 	copy_bl31ssram_image();
+
+	clear_swt_faults();
 #endif
 
 	/* This will also populate CSR section from bl31ssram */
-- 
2.17.1

