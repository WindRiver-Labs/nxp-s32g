From 6d6ed26da016932db79cb99542d26aa2db93698e Mon Sep 17 00:00:00 2001
From: Ghennadi Procopciuc <ghennadi.procopciuc@nxp.com>
Date: Wed, 16 Feb 2022 15:59:39 +0200
Subject: [PATCH 5/5] s32: Adapt BL33 entry point and dtb location

Issue: ALB-8514
Upstream-Status: Pending 

Signed-off-by: Ghennadi Procopciuc <ghennadi.procopciuc@nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 plat/nxp/s32/include/s32_platform_def.h | 10 +++++++---
 plat/nxp/s32/s32_common.mk              |  2 +-
 2 files changed, 8 insertions(+), 4 deletions(-)

diff --git a/plat/nxp/s32/include/s32_platform_def.h b/plat/nxp/s32/include/s32_platform_def.h
index 90501fb1c..6768cc849 100644
--- a/plat/nxp/s32/include/s32_platform_def.h
+++ b/plat/nxp/s32/include/s32_platform_def.h
@@ -99,15 +99,19 @@
 #define BOOTROM_ADMA_RSRVD_BASE		(0x343ff000)
 #define BL2_LIMIT					(BOOTROM_ADMA_RSRVD_BASE - 1)
 
-/* U-boot addresses in SRAM. BL33_DTB and BL33_ENTRYPOINT must be kept in
- * sync with u-boot's CONFIG_DTB_SRAM_ADDR and CONFIG_SYS_TEXT_BASE.
+/* U-boot addresses in DDR.
+ * BL33_MAX_DTB_SIZE and BL33_ENTRYPOINT must be kept in sync
+ * with U-Boot's CONFIG_S32GEN1_MAX_DTB_SIZE and CONFIG_SYS_TEXT_BASE.
  */
 #define S32_BL33_IMAGE_SIZE	        (5 * SIZE_1M)
 /* Leave a gap between BL33 and BL31 to avoid MMU entries merge */
 #define BL33_BASE		        (S32_DDR0_END - S32_BL33_IMAGE_SIZE - \
 						SIZE_1M + 1)
-#define BL33_DTB		        (BL33_BASE + 0x90000)
+/* U-Boot: CONFIG_S32GEN1_MAX_DTB_SIZE */
+#define BL33_MAX_DTB_SIZE	    (0x7000)
+/* U-Boot: CONFIG_SYS_TEXT_BASE  */
 #define BL33_ENTRYPOINT		    (BL33_BASE + 0xa0000)
+#define BL33_DTB		    (BL33_ENTRYPOINT - BL33_MAX_DTB_SIZE)
 #define S32_BL33_IMAGE_BASE	    (BL33_DTB)
 #define S32_BL33_LIMIT	        (S32_DDR0_END)
 
diff --git a/plat/nxp/s32/s32_common.mk b/plat/nxp/s32/s32_common.mk
index 824a6390c..7f76d5ed2 100644
--- a/plat/nxp/s32/s32_common.mk
+++ b/plat/nxp/s32/s32_common.mk
@@ -200,7 +200,7 @@ ifeq ($(MKIMAGE),)
 BL33DIR = $(shell dirname $(BL33))
 MKIMAGE = $(BL33DIR)/tools/mkimage
 endif
-MKIMAGE_CFG ?= ${BL33DIR}/u-boot.cfgout
+MKIMAGE_CFG ?= ${BL33DIR}/u-boot-s32.cfgout
 
 DUMMY_STAGE := ${BUILD_PLAT}/dummy_fip_stage
 DUMMY_FIP := ${BUILD_PLAT}/dummy_fip
-- 
2.17.1

