From ac9f38b80b49817ed8b422e5b9cb63e66765ed88 Mon Sep 17 00:00:00 2001
From: Ghennadi Procopciuc <ghennadi.procopciuc@nxp.com>
Date: Thu, 14 Oct 2021 11:27:36 +0300
Subject: [PATCH 17/24] s32g: Disable half of the cores when running in
 lockstep during suspend

Issue: ALB-7955
Upstream-Status: Pending 

Signed-off-by: Ghennadi Procopciuc <ghennadi.procopciuc@nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 plat/nxp/s32g/s32g_psci.c | 6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

diff --git a/plat/nxp/s32g/s32g_psci.c b/plat/nxp/s32g/s32g_psci.c
index 4ccf96b0e..542411fbd 100644
--- a/plat/nxp/s32g/s32g_psci.c
+++ b/plat/nxp/s32g/s32g_psci.c
@@ -155,6 +155,7 @@ static void set_warm_entry(void)
 static void __dead2 platform_suspend(unsigned int current_cpu)
 {
 	size_t i;
+	size_t ncores = PLATFORM_CORE_COUNT;
 
 	for (i = 0; i < PLATFORM_CORE_COUNT; i++)
 		gicv3_cpuif_disable(i);
@@ -169,8 +170,11 @@ static void __dead2 platform_suspend(unsigned int current_cpu)
 	s32g_turn_off_core(S32G_MC_ME_CM7_PART, 1);
 	s32g_turn_off_core(S32G_MC_ME_CM7_PART, 0);
 
+	if (is_lockstep_enabled())
+		ncores /= 2;
+
 	/* A53 cores */
-	for (i = 0; i < PLATFORM_CORE_COUNT; i++) {
+	for (i = 0; i < ncores; i++) {
 		if (i != current_cpu)
 			s32g_turn_off_core(S32G_MC_ME_CA53_PART, i);
 	}
-- 
2.17.1

