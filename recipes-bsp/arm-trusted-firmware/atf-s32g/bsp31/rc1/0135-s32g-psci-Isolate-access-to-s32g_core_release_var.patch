From fbae7acb3a6745e617877bb0711ea931a3bfd21c Mon Sep 17 00:00:00 2001
From: Ghennadi Procopciuc <Ghennadi.Procopciuc@nxp.com>
Date: Wed, 1 Jul 2020 11:06:08 +0300
Subject: [PATCH 135/269] s32g: psci: Isolate access to s32g_core_release_var

Create a setter for s32g_core_release_var accesses

Issue: ALB-4909
Upstream-Status: Pending 

Signed-off-by: Ghennadi Procopciuc <Ghennadi.Procopciuc@nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 plat/s32g/s32g_psci.c | 11 ++++++++---
 1 file changed, 8 insertions(+), 3 deletions(-)

diff --git a/plat/s32g/s32g_psci.c b/plat/s32g/s32g_psci.c
index 3b01b26f2..56923e436 100644
--- a/plat/s32g/s32g_psci.c
+++ b/plat/s32g/s32g_psci.c
@@ -45,6 +45,13 @@ static bool is_core_in_secondary_cluster(int pos)
 	return (pos == 2 || pos == 3);
 }
 
+static void update_core_state(uint32_t core, uint32_t state)
+{
+	s32g_core_release_var[core] = state;
+	flush_dcache_range((uintptr_t)&s32g_core_release_var[core],
+			   sizeof(s32g_core_release_var[core]));
+}
+
 /** Executed by the running (primary) core as part of the PSCI_CPU_ON
  *  call, e.g. during Linux kernel boot.
  */
@@ -72,9 +79,7 @@ static int s32g_pwr_domain_on(u_register_t mpidr)
 
 	/* Kick the secondary core out of wfi */
 	NOTICE("S32G TF-A: %s: booting up core %d\n", __func__, pos);
-	s32g_core_release_var[pos] = 1;
-	flush_dcache_range((uintptr_t)&s32g_core_release_var[pos],
-			   sizeof(s32g_core_release_var[pos]));
+	update_core_state(pos, 1);
 	plat_ic_raise_el3_sgi(S32G_SECONDARY_WAKE_SGI, mpidr);
 	if (is_core_in_secondary_cluster(pos) &&
 			!ncore_is_caiu_online(A53_CLUSTER1_CAIU))
-- 
2.17.1

