From 6d75a6bccdad338cb61cd4a61f8832e8312dc656 Mon Sep 17 00:00:00 2001
From: Bogdan Hamciuc <bogdan.hamciuc@nxp.com>
Date: Thu, 23 Jan 2020 05:55:59 +0200
Subject: [PATCH 069/269] s32g274a: Add Ncore to the EL3 (BL31) MMU

Upstream-Status: Pending 

Signed-off-by: Bogdan Hamciuc <bogdan.hamciuc@nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
Issue: ALB-4497
---
 plat/s32g/include/platform_def.h | 4 ++--
 plat/s32g/s32g275_bl31.c         | 6 ++++++
 2 files changed, 8 insertions(+), 2 deletions(-)

diff --git a/plat/s32g/include/platform_def.h b/plat/s32g/include/platform_def.h
index 795860674..35687aa6f 100644
--- a/plat/s32g/include/platform_def.h
+++ b/plat/s32g/include/platform_def.h
@@ -148,8 +148,8 @@
 #if defined IMAGE_BL31
 #define FIRMWARE_WELCOME_STR_S32G_BL31	"This is S32G BL31\n"
 /* To limit usage, keep these in sync with sizeof(s32g_mmap) */
-#define MAX_MMAP_REGIONS		10
-#define MAX_XLAT_TABLES			10
+#define MAX_MMAP_REGIONS		11
+#define MAX_XLAT_TABLES			11
 #endif
 #if defined IMAGE_BL33
 #pragma warning "BL33 image is being built; you should configure it out."
diff --git a/plat/s32g/s32g275_bl31.c b/plat/s32g/s32g275_bl31.c
index 36cf510cc..5b511472b 100644
--- a/plat/s32g/s32g275_bl31.c
+++ b/plat/s32g/s32g275_bl31.c
@@ -20,6 +20,7 @@
 #include "s32g_xrdc.h"
 #include "s32g_clocks.h"
 #include "s32g_pinctrl.h"
+#include "s32g_ncore.h"
 
 #include "s32g274a_pm.h"
 
@@ -43,6 +44,11 @@ static const mmap_region_t s32g_mmap[] = {
 			MT_DEVICE | MT_RW),
 	MAP_REGION_FLAT(S32G_MC_RGM_BASE_ADDR, S32G_MC_RGM_SIZE,
 			MT_DEVICE | MT_RW),
+	/* When we execute at System Monitor on behalf of EL2/EL1, we might
+	 * have to reconfigure Ncore
+	 */
+	MAP_REGION_FLAT(NCORE_BASE_ADDR, S32G_NCORE_SIZE,
+			MT_DEVICE | MT_RW),
 	MAP_REGION_FLAT(S32G_BL33_IMAGE_BASE, S32G_BL33_IMAGE_SIZE,
 			MT_MEMORY | MT_RW),
 	MAP_REGION_FLAT(S32G_PMEM_START, S32G_PMEM_LEN,
-- 
2.17.1

