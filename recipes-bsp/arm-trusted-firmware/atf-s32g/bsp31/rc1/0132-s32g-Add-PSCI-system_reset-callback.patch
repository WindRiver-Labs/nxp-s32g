From 02177d4eff80b23deaf9ea6decb2b95e5b833785 Mon Sep 17 00:00:00 2001
From: Ghennadi Procopciuc <Ghennadi.Procopciuc@nxp.com>
Date: Wed, 24 Jun 2020 16:01:49 +0300
Subject: [PATCH 132/269] s32g: Add PSCI system_reset callback

Issue: ALB-4659
Upstream-Status: Pending 

Signed-off-by: Ghennadi Procopciuc <Ghennadi.Procopciuc@nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 plat/s32g/include/s32g_mc_me.h | 3 +++
 plat/s32g/s32g_mc_me.c         | 9 +++++++++
 plat/s32g/s32g_psci.c          | 8 ++++++++
 3 files changed, 20 insertions(+)

diff --git a/plat/s32g/include/s32g_mc_me.h b/plat/s32g/include/s32g_mc_me.h
index 23fa1c286..e28b35735 100644
--- a/plat/s32g/include/s32g_mc_me.h
+++ b/plat/s32g/include/s32g_mc_me.h
@@ -15,6 +15,8 @@
 #define S32G_MC_ME_SIZE		0x1000ul
 
 #define MC_ME_MODE_CONF		(S32G_MC_ME_BASE_ADDR + 0x4)
+#define MC_ME_MODE_CONF_DRST	BIT(0)
+#define MC_ME_MODE_CONF_FRST	BIT(1)
 #define MC_ME_MODE_CONF_STANDBY	BIT(15)
 
 #define MC_ME_MODE_UPD		(S32G_MC_ME_BASE_ADDR + 0x8)
@@ -102,6 +104,7 @@ void s32g_disable_cofb_clk(uint8_t part, uint32_t keep_blocks);
 void s32g_set_stby_master_core(uint8_t part, uint8_t core);
 void mc_me_enable_partition_block(uint32_t part, uint32_t block);
 void mc_me_enable_partition(uint32_t part);
+void s32g_destructive_reset(void);
 
 
 #endif /* __S32G_MC_ME_H__ */
diff --git a/plat/s32g/s32g_mc_me.c b/plat/s32g/s32g_mc_me.c
index 4428df7fd..dab7e6574 100644
--- a/plat/s32g/s32g_mc_me.c
+++ b/plat/s32g/s32g_mc_me.c
@@ -376,3 +376,12 @@ void s32g_set_stby_master_core(uint8_t part, uint8_t core)
 	/* Write valid key sequence to trigger the update. */
 	mc_me_apply_hw_changes();
 }
+
+void s32g_destructive_reset(void)
+{
+	mmio_write_32(MC_ME_MODE_CONF, MC_ME_MODE_CONF_DRST);
+	mmio_write_32(MC_ME_MODE_UPD, MC_ME_MODE_UPD_UPD);
+
+	/* Write valid key sequence to trigger the reset. */
+	mc_me_apply_hw_changes();
+}
diff --git a/plat/s32g/s32g_psci.c b/plat/s32g/s32g_psci.c
index b07d6ade2..6ccdf5fa1 100644
--- a/plat/s32g/s32g_psci.c
+++ b/plat/s32g/s32g_psci.c
@@ -395,6 +395,13 @@ static void s32g_pwr_domain_off(const psci_power_state_t *target_state)
 	NOTICE("S32G TF-A: %s\n", __func__);
 }
 
+void __dead2 s32g_system_reset(void)
+{
+	NOTICE("S32G TF-A: %s\n", __func__);
+	s32g_destructive_reset();
+	plat_panic_handler();
+}
+
 const plat_psci_ops_t s32g_psci_pm_ops = {
 	/* cap: PSCI_CPU_OFF */
 	.pwr_domain_off = s32g_pwr_domain_off,
@@ -409,6 +416,7 @@ const plat_psci_ops_t s32g_psci_pm_ops = {
 					s32g_pwr_domain_suspend_pwrdown_early,
 	.pwr_domain_suspend_finish = s32g_pwr_domain_suspend_finish,
 	.pwr_domain_pwr_down_wfi = s32g_pwr_domain_pwr_down_wfi,
+	.system_reset = s32g_system_reset,
 };
 
 int plat_setup_psci_ops(uintptr_t sec_entrypoint,
-- 
2.17.1

