From bfaa371b6b34d7d609d3567ecd0f183e17197f63 Mon Sep 17 00:00:00 2001
From: Bogdan Hamciuc <bogdan.hamciuc@nxp.com>
Date: Thu, 12 Dec 2019 11:54:37 +0200
Subject: [PATCH 039/269] s32g: Init SRAM area for BL31

Upstream-Status: Pending 

Signed-off-by: Bogdan Hamciuc <bogdan.hamciuc@nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
Issue: ALB-4277
---
 plat/s32g/include/platform_def.h |  7 +++++++
 plat/s32g/include/s32g_storage.h |  8 --------
 plat/s32g/s32g274a_storage.c     | 11 ++++++++++-
 plat/s32g/s32g_lowlevel_bl2.S    | 10 +++++++++-
 plat/s32g/s32g_lowlevel_common.S |  2 +-
 5 files changed, 27 insertions(+), 11 deletions(-)

diff --git a/plat/s32g/include/platform_def.h b/plat/s32g/include/platform_def.h
index 1a5788df9..b632e9990 100644
--- a/plat/s32g/include/platform_def.h
+++ b/plat/s32g/include/platform_def.h
@@ -129,6 +129,13 @@
  */
 #define S32G_BL31_OFF_IN_SRAM		0x00400000
 #define BL31_BASE			(S32G_SRAM_BASE + S32G_BL31_OFF_IN_SRAM)
+/* Temporary SRAM map:
+ * - 0x3402_0000	U-Boot (runtime image, i.e. S32G_BL33_IMAGE_BASE)
+ * - 0x3420_0000	Temporary BL31 (for development only)
+ * - 0x3430_0000	BL2 (runtime image, i.e. BL2_BASE)
+ * - 0x3440_0000	BL31 (runtime image, i.e. BL31_BASE)
+ */
+#define TEMP_S32G_BL31_READ_ADDR_IN_SRAM	0x34200000ull
 
 /* BL2 may reside before or after BL31 in SRAM */
 #if (S32G_BL2_OFF_IN_SRAM < S32G_BL31_OFF_IN_SRAM)
diff --git a/plat/s32g/include/s32g_storage.h b/plat/s32g/include/s32g_storage.h
index fd00669f1..e156f2570 100644
--- a/plat/s32g/include/s32g_storage.h
+++ b/plat/s32g/include/s32g_storage.h
@@ -6,14 +6,6 @@
 #ifndef S32G_STORAGE_H
 #define S32G_STORAGE_H
 
-/* Temporary SRAM map:
- * - 0x3402_0000	U-Boot (runtime image, i.e. S32G_BL33_IMAGE_BASE)
- * - 0x3420_0000	Temporary BL31 (for development only)
- * - 0x3430_0000	BL2 (runtime image, i.e. BL2_BASE)
- * - 0x3440_0000	BL31 (runtime image, i.e. BL31_BASE)
- */
-#define TEMP_S32G_BL31_READ_ADDR_IN_SRAM	0x34200000ull
-
 enum s32g_boot_source {
 	S32G_SRAM_BOOT,
 	/* TODO add FIP, QSPI, SD/MMC */
diff --git a/plat/s32g/s32g274a_storage.c b/plat/s32g/s32g274a_storage.c
index a94623605..009486b5e 100644
--- a/plat/s32g/s32g274a_storage.c
+++ b/plat/s32g/s32g274a_storage.c
@@ -17,8 +17,17 @@ static uintptr_t s32g_sram_boot_dev_handle;
 static int s32g_check_sram_dev(const uintptr_t spec);
 
 static const io_block_spec_t bl31_sram_spec = {
+	/* FIXME This layout is *only* valid for the development version */
 	.offset = TEMP_S32G_BL31_READ_ADDR_IN_SRAM,
-	.length = BL31_LIMIT - BL31_BASE
+#if (TEMP_S32G_BL31_READ_ADDR_IN_SRAM < BL2_BASE)
+#if (BL2_BASE - TEMP_S32G_BL31_READ_ADDR_IN_SRAM < BL31_LIMIT - BL31_BASE)
+	.length = BL2_BASE - TEMP_S32G_BL31_READ_ADDR_IN_SRAM,
+#else
+	.length = BL31_LIMIT - BL31_BASE,
+#endif
+#else
+#error "Unsupported BL31 layout, please check SRAM memory map"
+#endif
 };
 
 static const struct plat_io_policy s32g_policies[] = {
diff --git a/plat/s32g/s32g_lowlevel_bl2.S b/plat/s32g/s32g_lowlevel_bl2.S
index 1c7aced88..d14a33b6c 100644
--- a/plat/s32g/s32g_lowlevel_bl2.S
+++ b/plat/s32g/s32g_lowlevel_bl2.S
@@ -38,11 +38,19 @@ func plat_reset_handler
 	/* Ncore quirks */
 	bl	s32g_ncore_isol_cluster0
 
-	/* Initialize SRAM, as BootROM did us no favours */
+	/*
+	 * Initialize SRAM, as BootROM did us no favours
+	 */
+	/* Some BL2 sections need to be initialized */
 	ldr	x0,=__STACKS_START__
 	ldr	x1,=__BL2_END__
 	sub	x1, x1, x0
 	bl	s32g_sram_init
+	/* Target area for BL31 needs to be initialized, also */
+	ldr	x0,=BL31_BASE
+	ldr	x1,=BL31_LIMIT
+	sub	x1, x1, x0
+	bl	s32g_sram_init
 
 	mov	x30, x7
 	ret
diff --git a/plat/s32g/s32g_lowlevel_common.S b/plat/s32g/s32g_lowlevel_common.S
index 3a9c1994c..16296d780 100644
--- a/plat/s32g/s32g_lowlevel_common.S
+++ b/plat/s32g/s32g_lowlevel_common.S
@@ -57,7 +57,7 @@ init:
 	cmp	x11, xzr
 	bne	assert_loop
 	cmp	x0, x1
-	ble	init
+	blt	init
 
 	mov x30, x9
 	ret
-- 
2.17.1

