From abcb82760ff517a9ba09051e5649fbc7b7919587 Mon Sep 17 00:00:00 2001
From: Dan Nica <dan.nica@nxp.com>
Date: Wed, 15 Jan 2020 14:42:21 +0200
Subject: [PATCH 060/269] ssram: Init the first 1KB of Standby SRAM

Issue: ALB-4507
Upstream-Status: Pending 

Signed-off-by: Dan Nica <dan.nica@nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 include/drivers/nxp/s32g/ddr/ddrss.h | 2 ++
 plat/s32g/include/platform_def.h     | 2 ++
 plat/s32g/s32g274a_bl2_el3.c         | 7 ++++++-
 3 files changed, 10 insertions(+), 1 deletion(-)

diff --git a/include/drivers/nxp/s32g/ddr/ddrss.h b/include/drivers/nxp/s32g/ddr/ddrss.h
index 548e1cd8b..2f0119205 100644
--- a/include/drivers/nxp/s32g/ddr/ddrss.h
+++ b/include/drivers/nxp/s32g/ddr/ddrss.h
@@ -10,6 +10,8 @@
 #include <stddef.h>
 #include <lib/mmio.h>
 
+#define STANDBY_SRAM_USED_FOR_CSR	(0x400)
+
 #define DDRSS_BASE_ADDR			0x40380000
 
 #define DDRSS_DMEM_ADDR			(DDRSS_BASE_ADDR + 0x30000)
diff --git a/plat/s32g/include/platform_def.h b/plat/s32g/include/platform_def.h
index e6a682a4a..795860674 100644
--- a/plat/s32g/include/platform_def.h
+++ b/plat/s32g/include/platform_def.h
@@ -83,6 +83,8 @@
 #define S32G_SRAM_SIZE		0x00800000
 #define S32G_SRAM_END		(S32G_SRAM_BASE + S32G_SRAM_SIZE)
 
+#define STANDBY_SRAM_BASE	(0x24000000ul)
+
 /* Top of the 4GB of physical memory, accessible through the
  * extended memory map.
  */
diff --git a/plat/s32g/s32g274a_bl2_el3.c b/plat/s32g/s32g274a_bl2_el3.c
index 31a23741f..3a2b214c4 100644
--- a/plat/s32g/s32g274a_bl2_el3.c
+++ b/plat/s32g/s32g274a_bl2_el3.c
@@ -117,10 +117,15 @@ void bl2_el3_plat_arch_setup(void)
 	static struct console_s32g console;
 	extern struct ddrss_conf ddrss_conf;
 	extern struct ddrss_firmware ddrss_firmware;
+	extern void s32g_sram_init(uintptr_t start, uintptr_t end);
 
 	console_s32g_register(S32G_UART_BASE, S32G_UART_CLOCK_HZ,
 			      S32G_UART_BAUDRATE, &console);
-	ddrss_init(&ddrss_conf, &ddrss_firmware);
+
+	if (get_reset_cause() != CAUSE_WAKEUP_DURING_STANDBY) {
+		s32g_sram_init(STANDBY_SRAM_BASE, STANDBY_SRAM_USED_FOR_CSR);
+		ddrss_init(&ddrss_conf, &ddrss_firmware);
+	}
 }
 
 REGISTER_BL_IMAGE_DESCS(s32g_bl2_mem_params_descs)
-- 
2.17.1

