From 27217034232214b7823f22b82741129dc28ba86e Mon Sep 17 00:00:00 2001
From: Ghennadi Procopciuc <Ghennadi.Procopciuc@nxp.com>
Date: Fri, 25 Sep 2020 13:26:51 +0300
Subject: [PATCH 176/269] s32g: dtb: Add clocks modules

Issue: ALB-4294, ALB-5510
Upstream-Status: Pending 

Signed-off-by: Ghennadi Procopciuc <Ghennadi.Procopciuc@nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 fdts/fsl-s32-gen1.dtsi                        | 357 ++++++++++++++++++
 .../{s32g274aevb.dts => fsl-s32g274a-rdb.dts} |  13 +-
 fdts/fsl-s32g274a.dtsi                        |  59 +++
 plat/nxp/s32g/platform.mk                     |   2 +-
 4 files changed, 424 insertions(+), 7 deletions(-)
 create mode 100644 fdts/fsl-s32-gen1.dtsi
 rename fdts/{s32g274aevb.dts => fsl-s32g274a-rdb.dts} (78%)
 create mode 100644 fdts/fsl-s32g274a.dtsi

diff --git a/fdts/fsl-s32-gen1.dtsi b/fdts/fsl-s32-gen1.dtsi
new file mode 100644
index 000000000..95b2ddbf5
--- /dev/null
+++ b/fdts/fsl-s32-gen1.dtsi
@@ -0,0 +1,357 @@
+/*
+ * Copyright 2020 NXP
+ *
+ * SPDX-License-Identifier: BSD-3-Clause
+ */
+
+#include <dt-bindings/clock/s32gen1-clock-freq.h>
+#include <dt-bindings/clock/s32gen1-clock.h>
+
+/ {
+	#address-cells = <2>;
+	#size-cells = <2>;
+
+	fxosc: fxosc@40050000 {
+		compatible = "fixed-clock", "fsl,s32gen1-fxosc";
+		reg = <0x0 0x40050000 0x0 0x3000>;
+		clock-frequency = <S32GEN1_FXOSC_FREQ>;
+		#clock-cells = <1>;
+	};
+
+	firc: firc {
+		compatible = "fixed-clock";
+		clock-frequency = <51000000>;
+		#clock-cells = <1>;
+	};
+
+	sirc: sirc {
+		compatible = "fixed-clock";
+		clock-frequency = <32000>;
+		#clock-cells = <1>;
+	};
+
+	ftm0_ext: ftm0_ext {
+		compatible = "fixed-clock";
+		clock-frequency = <20000000>;
+		#clock-cells = <1>;
+	};
+
+	ftm1_ext: ftm1_ext {
+		compatible = "fixed-clock";
+		clock-frequency = <20000000>;
+		#clock-cells = <1>;
+	};
+
+	gmac0_ext_rx: gmac0_ext_rx {
+		compatible = "fixed-clock";
+		clock-frequency = <25000000>;
+		#clock-cells = <1>;
+	};
+
+	gmac0_ext_tx: gmac0_ext_tx {
+		compatible = "fixed-clock";
+		clock-frequency = <125000000>;
+		#clock-cells = <1>;
+	};
+
+	gmac0_ext_ref: gmac0_ext_ref {
+		compatible = "fixed-clock";
+		clock-frequency = <50000000>;
+		#clock-cells = <1>;
+	};
+
+	gmac0_ext_ts: gmac0_ext_ts {
+		compatible = "fixed-clock";
+		clock-frequency = <200000000>;
+		#clock-cells = <1>;
+	};
+
+	serdes0_lane0_ext_cdr: serdes0_lane0_ext_cdr {
+		compatible = "fixed-clock";
+		clock-frequency = <125000000>;
+		#clock-cells = <1>;
+	};
+
+	serdes0_lane0_ext_tx: serdes0_lane0_ext_tx {
+		compatible = "fixed-clock";
+		clock-frequency = <125000000>;
+		#clock-cells = <1>;
+	};
+
+	serdes0_lane1_ext_cdr: serdes0_lane1_ext_cdr {
+		compatible = "fixed-clock";
+		clock-frequency = <125000000>;
+		#clock-cells = <1>;
+	};
+
+	serdes0_lane1_ext_tx: serdes0_lane1_ext_tx {
+		compatible = "fixed-clock";
+		clock-frequency = <125000000>;
+		#clock-cells = <1>;
+	};
+
+	serdes1_lane0_ext_cdr: serdes1_lane0_ext_cdr {
+		compatible = "fixed-clock";
+		clock-frequency = <125000000>;
+		#clock-cells = <1>;
+	};
+
+	serdes1_lane0_ext_tx: serdes1_lane0_ext_tx {
+		compatible = "fixed-clock";
+		clock-frequency = <125000000>;
+		#clock-cells = <1>;
+	};
+
+	serdes1_lane1_ext_cdr: serdes1_lane1_ext_cdr {
+		compatible = "fixed-clock";
+		clock-frequency = <125000000>;
+		#clock-cells = <1>;
+	};
+
+	serdes1_lane1_ext_tx: serdes1_lane1_ext_tx {
+		compatible = "fixed-clock";
+		clock-frequency = <125000000>;
+		#clock-cells = <1>;
+	};
+
+	clks: clks {
+		compatible = "fsl,s32-gen1-clocking";
+		#address-cells = <2>;
+		#size-cells = <2>;
+		#clock-cells = <1>;
+		status = "okay";
+
+		assigned-clocks =
+			<&clks S32GEN1_CLK_FXOSC>,
+			<&clks S32GEN1_CLK_FIRC>,
+			<&clks S32GEN1_CLK_SIRC>,
+			<&clks S32GEN1_CLK_GMAC0_EXT_RX>,
+			<&clks S32G274A_CLK_SERDES1_LANE0_TX>,
+			<&clks S32G274A_CLK_SERDES1_LANE0_CDR>,
+			<&clks S32G274A_CLK_SERDES1_LANE1_TX>,
+			<&clks S32G274A_CLK_SERDES1_LANE1_CDR>,
+			<&clks S32GEN1_CLK_SERDES0_LANE0_TX>,
+			<&clks S32GEN1_CLK_SERDES0_LANE0_CDR>,
+			<&clks S32G274A_CLK_SERDES0_LANE1_TX>,
+			<&clks S32G274A_CLK_SERDES0_LANE1_CDR>,
+			<&clks S32GEN1_CLK_SERDES_REF>;
+		assigned-clock-parents =
+			<&fxosc 0>,
+			<&firc 0>,
+			<&sirc 0>,
+			<&gmac0_ext_rx 0>,
+			<&serdes1_lane0_ext_tx 0>,
+			<&serdes1_lane0_ext_cdr 0>,
+			<&serdes1_lane1_ext_tx 0>,
+			<&serdes1_lane1_ext_cdr 0>,
+			<&serdes0_lane0_ext_tx 0>,
+			<&serdes0_lane0_ext_cdr 0>,
+			<&serdes0_lane1_ext_tx 0>,
+			<&serdes0_lane1_ext_cdr 0>;
+		assigned-clock-rates =
+			<0>, <0>, <0>, <0>,
+			<0>, <0>, <0>, <0>,
+			<0>, <0>, <0>, <0>,
+			<100000000>;
+
+		armpll: armpll@4003800 {
+			compatible = "fsl,s32gen1-armpll";
+			reg = <0x0 0x40038000 0x0 0x3000>;
+
+			assigned-clocks =
+				<&clks S32GEN1_CLK_ARM_PLL_MUX>,
+				<&clks S32GEN1_CLK_ARM_PLL_VCO>,
+				<&clks S32GEN1_CLK_ARM_PLL_PHI0>;
+			assigned-clock-parents =
+				<&clks S32GEN1_CLK_FXOSC>;
+			assigned-clock-rates =
+				<0>,
+				<S32GEN1_ARM_PLL_VCO_MAX_FREQ>,
+				<S32GEN1_ARM_PLL_PHI0_MAX_FREQ>;
+		};
+
+		armdfs: armdfs@40054000 {
+			compatible = "fsl,s32gen1-armdfs";
+			reg = <0x0 0x40054000 0x0 0x3000>;
+
+			assigned-clocks =
+				<&clks S32GEN1_CLK_ARM_PLL_DFS1>,
+				<&clks S32GEN1_CLK_ARM_PLL_DFS2>;
+			assigned-clock-rates =
+				<800000000>,
+				<800000000>;
+		};
+
+		periphpll: periphpll@4003C000 {
+			compatible = "fsl,s32gen1-periphpll";
+			reg = <0x0 0x4003C000 0x0 0x3000>;
+
+			assigned-clocks =
+				<&clks S32GEN1_CLK_PERIPH_PLL_MUX>,
+				<&clks S32GEN1_CLK_PERIPH_PLL_VCO>,
+				<&clks S32GEN1_CLK_PERIPH_PLL_PHI0>,
+				<&clks S32GEN1_CLK_PERIPH_PLL_PHI1>,
+				<&clks S32GEN1_CLK_PERIPH_PLL_PHI2>,
+				<&clks S32GEN1_CLK_PERIPH_PLL_PHI3>,
+				<&clks S32GEN1_CLK_PERIPH_PLL_PHI4>,
+				<&clks S32GEN1_CLK_PERIPH_PLL_PHI5>,
+				<&clks S32GEN1_CLK_PERIPH_PLL_PHI7>;
+			assigned-clock-parents =
+				<&clks S32GEN1_CLK_FXOSC>;
+			assigned-clock-rates =
+				<0>,
+				<S32GEN1_PERIPH_PLL_VCO_FREQ>, <100000000>,
+				<80000000>, <80000000>,
+				<125000000>, <200000000>,
+				<125000000>, <100000000>;
+		};
+
+		periphdfs: armdfs@40058000 {
+			compatible = "fsl,s32gen1-periphdfs";
+			reg = <0x0 0x40058000 0x0 0x3000>;
+
+			assigned-clocks =
+				<&clks S32GEN1_CLK_PERIPH_PLL_DFS1>,
+				<&clks S32GEN1_CLK_PERIPH_PLL_DFS3>;
+			assigned-clock-rates =
+				<800000000>,
+				<800000000>;
+		};
+
+		accelpll: accelpll@40040000 {
+			compatible = "fsl,s32gen1-accelpll";
+			reg = <0x0 0x40040000 0x0 0x3000>;
+		};
+
+		ddrpll: ddrpll@40044000 {
+			compatible = "fsl,s32gen1-ddrpll";
+			reg = <0x0 0x40044000 0x0 0x3000>;
+
+			assigned-clocks =
+				<&clks S32GEN1_CLK_DDR_PLL_MUX>,
+				<&clks S32GEN1_CLK_DDR_PLL_VCO>,
+				<&clks S32GEN1_CLK_DDR_PLL_PHI0>;
+			assigned-clock-parents =
+				<&clks S32GEN1_CLK_FXOSC>;
+			assigned-clock-rates =
+				<0>,
+				<S32GEN1_DDR_PLL_VCO_FREQ>,
+				<S32GEN1_DDR_FREQ>;
+		};
+
+		mc_me: mc_me@40088000 {
+			compatible = "fsl,s32gen1-mc_me";
+			reg = <0x0 0x40088000 0x0 0x3000>;
+		};
+
+		rdc: rdc@440080000 {
+			compatible = "fsl,s32gen1-rdc";
+			reg = <0x0 0x40080000 0x0 0x3000>;
+		};
+
+		rgm: rgm@40078000 {
+			compatible = "fsl,s32gen1-rgm";
+			reg = <0x0 0x40078000 0x0 0x3000>;
+		};
+
+		mc_cgm0: mc_cgm0@40030000 {
+			compatible = "fsl,s32gen1-mc_cgm0";
+			reg = <0x0 0x40030000 0x0 0x3000>;
+
+			assigned-clocks =
+				<&clks S32GEN1_CLK_MC_CGM0_MUX0>,
+				<&clks S32GEN1_CLK_MC_CGM0_MUX3>,
+				<&clks S32GEN1_CLK_MC_CGM0_MUX4>,
+				<&clks S32GEN1_CLK_MC_CGM0_MUX5>,
+				<&clks S32GEN1_CLK_MC_CGM0_MUX7>,
+				<&clks S32GEN1_CLK_MC_CGM0_MUX8>,
+				<&clks S32GEN1_CLK_MC_CGM0_MUX9>,
+				<&clks S32GEN1_CLK_MC_CGM0_MUX10>,
+				<&clks S32GEN1_CLK_MC_CGM0_MUX12>,
+				<&clks S32GEN1_CLK_MC_CGM0_MUX14>,
+				<&clks S32GEN1_CLK_MC_CGM0_MUX16>,
+				<&clks S32GEN1_CLK_XBAR_2X>,
+				<&clks S32GEN1_CLK_PER>,
+				<&clks S32GEN1_CLK_FTM0_REF>,
+				<&clks S32GEN1_CLK_FTM1_REF>,
+				<&clks S32GEN1_CLK_CAN_PE>,
+				<&clks S32GEN1_CLK_LIN_BAUD>,
+				<&clks S32GEN1_CLK_GMAC0_TS>,
+				<&clks S32GEN1_CLK_SPI>,
+				<&clks S32GEN1_CLK_SDHC>;
+			assigned-clock-parents =
+				<&clks S32GEN1_CLK_ARM_PLL_DFS1>,
+				<&clks S32GEN1_CLK_PERIPH_PLL_PHI1>,
+				<&clks S32GEN1_CLK_PERIPH_PLL_PHI1>,
+				<&clks S32GEN1_CLK_PERIPH_PLL_PHI1>,
+				<&clks S32GEN1_CLK_PERIPH_PLL_PHI2>,
+				<&clks S32GEN1_CLK_PERIPH_PLL_PHI3>,
+				<&clks S32GEN1_CLK_PERIPH_PLL_PHI4>,
+				<&clks S32GEN1_CLK_PERIPH_PLL_PHI5>,
+				<&clks S32GEN1_CLK_PERIPH_PLL_DFS1>,
+				<&clks S32GEN1_CLK_PERIPH_PLL_DFS3>,
+				<&clks S32GEN1_CLK_PERIPH_PLL_PHI7>;
+			assigned-clock-rates =
+				<0>,
+				<0>,
+				<0>,
+				<0>,
+				<0>,
+				<0>,
+				<0>,
+				<0>,
+				<0>,
+				<0>,
+				<0>,
+				<S32GEN1_XBAR_2X_FREQ>,
+				<80000000>,
+				<40000000>,
+				<40000000>,
+				<80000000>,
+				<125000000>,
+				<200000000>,
+				<100000000>,
+				<200000000>;
+
+			clocks = <&clks S32GEN1_CLK_XBAR_2X>,
+				<&clks S32GEN1_CLK_SERDES_REF>,
+				<&clks S32GEN1_CLK_PER>,
+				<&clks S32GEN1_CLK_FTM0_REF>,
+				<&clks S32GEN1_CLK_FTM1_REF>,
+				<&clks S32GEN1_CLK_CAN_PE>,
+				<&clks S32GEN1_CLK_LIN_BAUD>,
+				<&clks S32GEN1_CLK_SPI>,
+				<&clks S32GEN1_CLK_SDHC>;
+		};
+
+		mc_cgm1: mc_cgm1@40034000 {
+			compatible = "fsl,s32gen1-mc_cgm1";
+			reg = <0x0 0x40034000 0x0 0x3000>;
+
+			assigned-clocks =
+				<&clks S32GEN1_CLK_MC_CGM1_MUX0>,
+				<&clks S32GEN1_CLK_A53_CORE>;
+			assigned-clock-parents =
+				<&clks S32GEN1_CLK_ARM_PLL_PHI0>,
+				<0>;
+			assigned-clock-rates =
+				<0>,
+				<S32GEN1_A53_MAX_FREQ>;
+		};
+
+		mc_cgm5: mc_cgm5@40068000 {
+			compatible = "fsl,s32gen1-mc_cgm5";
+			reg = <0x0 0x40068000 0x0 0x3000>;
+
+			assigned-clocks =
+				<&clks S32GEN1_CLK_MC_CGM5_MUX0>,
+				<&clks S32GEN1_CLK_DDR>;
+			assigned-clock-parents =
+				<&clks S32GEN1_CLK_DDR_PLL_PHI0>,
+				<0>;
+			assigned-clock-rates =
+				<0>,
+				<S32GEN1_DDR_FREQ>;
+		};
+	};
+};
diff --git a/fdts/s32g274aevb.dts b/fdts/fsl-s32g274a-rdb.dts
similarity index 78%
rename from fdts/s32g274aevb.dts
rename to fdts/fsl-s32g274a-rdb.dts
index 151fc11ec..1bd8568fe 100644
--- a/fdts/s32g274aevb.dts
+++ b/fdts/fsl-s32g274a-rdb.dts
@@ -6,11 +6,12 @@
 #include <dt-bindings/reset/s32gen1-wkpu.h>
 
 /dts-v1/;
+#include "fsl-s32g274a.dtsi"
 
 / {
-	compatible = "fsl,s32g274aevb";
-	#address-cells = <1>;
-	#size-cells = <1>;
+	compatible = "fsl,s32g274ardb";
+	#address-cells = <2>;
+	#size-cells = <2>;
 
 	aliases {
 		i2c4 = &i2c4;
@@ -20,13 +21,13 @@
 		compatible = "fsl,vf610-i2c";
 		#address-cells = <1>;
 		#size-cells = <0>;
-		reg = <0x402DC000 0x10000>;
+		reg = <0x0 0x402DC000 0x0 0x10000>;
 	};
 
 	wkpu: wkpu@40090000 {
 		compatible = "nxp,s32gen1-wkpu";
-		reg = <0x40090000 0x10000>, /* WKPU */
-		      <0x4007cb04 0x4>; /* S32G_STDBY_GPR */
+		reg = <0x0 0x40090000 0x0 0x10000>, /* WKPU */
+		      <0x0 0x4007cb04 0x0 0x4>; /* S32G_STDBY_GPR */
 		/*
 		 * Enable RTC and GPIO166 (J5, pin 30 on S32G274A RDB REV B)
 		 * as wake-up sources
diff --git a/fdts/fsl-s32g274a.dtsi b/fdts/fsl-s32g274a.dtsi
new file mode 100644
index 000000000..c1bdc9079
--- /dev/null
+++ b/fdts/fsl-s32g274a.dtsi
@@ -0,0 +1,59 @@
+/*
+ * Copyright 2020 NXP
+ *
+ * SPDX-License-Identifier: BSD-3-Clause
+ */
+
+#include <dt-bindings/clock/s32g274a-clock.h>
+
+/dts-v1/;
+#include "fsl-s32-gen1.dtsi"
+/ {
+	model = "NXP S32G274A";
+	compatible = "fsl,s32g274a-simu", "fsl,s32g274a", "fsl,s32gen1",
+		     "arm,vexpress,v2p-aarch64", "arm,vexpress";
+};
+
+&clks {
+	clocks = <&clks S32GEN1_CLK_PER>,
+		<&clks S32GEN1_CLK_FTM0_REF>,
+		<&clks S32GEN1_CLK_FTM1_REF>,
+		<&clks S32GEN1_CLK_CAN_PE>,
+		<&clks S32GEN1_CLK_XBAR_2X>,
+		<&clks S32GEN1_CLK_XBAR>,
+		<&clks S32GEN1_CLK_XBAR_DIV2>,
+		<&clks S32GEN1_CLK_XBAR_DIV3>,
+		<&clks S32GEN1_CLK_XBAR_DIV4>,
+		<&clks S32GEN1_CLK_XBAR_DIV6>,
+		<&clks S32GEN1_CLK_SPI>,
+		<&clks S32GEN1_CLK_QSPI>;
+
+	mc_cgm2: mc_cgm2@44018000 {
+		compatible = "fsl,s32gen1-mc_cgm2";
+		reg = <0x0 0x44018000 0x0 0x3000>;
+
+		assigned-clocks =
+			<&clks S32G274A_CLK_MC_CGM2_MUX0>,
+			<&clks S32G274A_CLK_PFE_PE>;
+		assigned-clock-rates =
+			<0>,
+			<600000000>;
+		assigned-clock-parents =
+			<&clks S32G274A_CLK_ACCEL_PLL_PHI1>;
+	};
+};
+
+&accelpll {
+	assigned-clocks =
+		<&clks S32GEN1_CLK_ACCEL_PLL_MUX>,
+		<&clks S32GEN1_CLK_ACCEL_PLL_VCO>,
+		<&clks S32G274A_CLK_ACCEL_PLL_PHI0>,
+		<&clks S32G274A_CLK_ACCEL_PLL_PHI1>;
+	assigned-clock-parents =
+		<&clks S32GEN1_CLK_FXOSC>;
+	assigned-clock-rates =
+		<0>,
+		<1800000000>,
+		<600000000>,
+		<600000000>;
+};
diff --git a/plat/nxp/s32g/platform.mk b/plat/nxp/s32g/platform.mk
index b49d04643..a12c5af65 100644
--- a/plat/nxp/s32g/platform.mk
+++ b/plat/nxp/s32g/platform.mk
@@ -78,7 +78,7 @@ BL31_SOURCES		+= plat/nxp/s32g/bl31_lowlevel.S \
 BL31_SOURCES		+= ${XLAT_TABLES_LIB_SRCS}
 
 # Device tree
-DTB_FILE_NAME		?= s32g274aevb.dtb
+DTB_FILE_NAME		?= fsl-s32g274a-rdb.dtb
 FDT_SOURCES             := $(addprefix fdts/, $(patsubst %.dtb,%.dts,$(DTB_FILE_NAME)))
 DTC_FLAGS		+= -Wno-unit_address_vs_reg
 
-- 
2.17.1

