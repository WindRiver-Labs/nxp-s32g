From e779fd9f0a315596c5618bf8315bbd0700667413 Mon Sep 17 00:00:00 2001
From: Dan Nica <dan.nica@nxp.com>
Date: Fri, 25 Sep 2020 14:22:05 +0300
Subject: [PATCH 172/269] s32g: Load u-boot built with OF_SEPARATE

Issue: ALB-5594
Upstream-Status: Pending 

Signed-off-by: Dan Nica <dan.nica@nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 plat/nxp/s32g/include/platform_def.h | 8 ++++++--
 plat/nxp/s32g/s32g_bl31.c            | 2 +-
 2 files changed, 7 insertions(+), 3 deletions(-)

diff --git a/plat/nxp/s32g/include/platform_def.h b/plat/nxp/s32g/include/platform_def.h
index 4e73879b1..ed3587996 100644
--- a/plat/nxp/s32g/include/platform_def.h
+++ b/plat/nxp/s32g/include/platform_def.h
@@ -156,8 +156,12 @@
 
 #define DTB_SIZE		(BL2_BASE - DTB_BASE)
 
-/* U-boot address in SRAM */
-#define S32G_BL33_IMAGE_BASE	(S32G_SRAM_BASE + 0xa0000)
+/* U-boot addresses in SRAM. BL33_DTB and BL33_ENTRYPOINT must be kept in
+ * sync with u-boot's CONFIG_DTB_SRAM_ADDR and CONFIG_SYS_TEXT_BASE.
+ */
+#define BL33_DTB		(S32G_SRAM_BASE + 0x90000)
+#define BL33_ENTRYPOINT		(S32G_SRAM_BASE + 0xa0000)
+#define S32G_BL33_IMAGE_BASE	(BL33_DTB)
 #define S32G_BL33_LIMIT		(S32G_SRAM_END)
 #define S32G_BL33_IMAGE_SIZE	(S32G_BL33_LIMIT - S32G_BL33_IMAGE_BASE)
 
diff --git a/plat/nxp/s32g/s32g_bl31.c b/plat/nxp/s32g/s32g_bl31.c
index fc0b5a0c0..1b5fb94c6 100644
--- a/plat/nxp/s32g/s32g_bl31.c
+++ b/plat/nxp/s32g/s32g_bl31.c
@@ -164,7 +164,7 @@ void bl31_early_platform_setup2(u_register_t arg0, u_register_t arg1,
 		u_register_t arg2, u_register_t arg3)
 {
 	SET_PARAM_HEAD(&bl33_image_ep_info, PARAM_EP, VERSION_1, 0);
-	bl33_image_ep_info.pc = S32G_BL33_IMAGE_BASE;
+	bl33_image_ep_info.pc = BL33_ENTRYPOINT;
 	bl33_image_ep_info.spsr = s32g_get_spsr_for_bl33_entry();
 	SET_SECURITY_STATE(bl33_image_ep_info.h.attr, NON_SECURE);
 }
-- 
2.17.1

