From c610e4c8134e4dca618638d6b6cb7e79e25b355b Mon Sep 17 00:00:00 2001
From: Bogdan Hamciuc <bogdan.hamciuc@nxp.com>
Date: Wed, 18 Dec 2019 11:03:05 +0200
Subject: [PATCH 044/269] s32g: Add pin muxing for SDHC

Upstream-Status: Pending 

Signed-off-by: Bogdan Hamciuc <bogdan.hamciuc@nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
Issue: ALB-4276
---
 plat/s32g/include/s32g_pinctrl.h | 34 ++++++++++++++++++++-
 plat/s32g/s32g_pinctrl.c         | 51 ++++++++++++++++++++++++++++++++
 2 files changed, 84 insertions(+), 1 deletion(-)

diff --git a/plat/s32g/include/s32g_pinctrl.h b/plat/s32g/include/s32g_pinctrl.h
index d940c6145..af0c87c10 100644
--- a/plat/s32g/include/s32g_pinctrl.h
+++ b/plat/s32g/include/s32g_pinctrl.h
@@ -25,11 +25,16 @@
 #define SIUL2_MSCR_S32_G1_SRC_100MHz            (5 << 14)
 #define SIUL2_MSCR_S32_G1_OBE_EN		BIT(21)
 #define SIUL2_MSCR_S32_G1_IBE_EN		BIT(19)
+#define SIUL2_MSCR_S32_G1_PUE_EN		BIT(13)
+#define SIUL2_MSCR_S32_G1_PUS_EN		BIT(12)
+#define SIUL2_MSCR_S32_G1_SMC_DIS		BIT(5)
 #define SIUL2_MSCR_MUX_MODE_ALT0		(0x0)
 #define SIUL2_MSCR_MUX_MODE_ALT1		(0x1)
 #define SIUL2_MSCR_MUX_MODE_ALT2		(0x2)
 
-
+/*
+ * Pinctrl for LinFlexD-UART
+ */
 #define SIUL2_MSCR_S32G_G1_PORT_CTRL_UART0_TXD	\
 	(SIUL2_MSCR_S32_G1_SRC_100MHz |		\
 	 SIUL2_MSCR_S32_G1_OBE_EN |		\
@@ -47,6 +52,33 @@
 #define SIUL2_PC10_MSCR_S32_G1_UART0		42
 #define SIUL2_PC10_IMCR_S32_G1_UART0		(512 - 512)
 
+/*
+ * Pinctrl for SDHC
+ */
+#define SIUL2_MSCR_S32_G1_SRC_208MHz		(0 << 14)
+#define SIUL2_USDHC_S32_G1_PAD_CTRL_BASE \
+	(SIUL2_MSCR_S32_G1_SRC_208MHz | \
+	 SIUL2_MSCR_S32_G1_OBE_EN | \
+	 SIUL2_MSCR_S32_G1_IBE_EN | \
+	 SIUL2_MSCR_S32_G1_PUE_EN | \
+	 SIUL2_MSCR_S32_G1_SMC_DIS)
+#define SIUL2_USDHC_S32_G1_PAD_CTRL_CLK \
+	(SIUL2_USDHC_S32_G1_PAD_CTRL_BASE | \
+	 SIUL2_MSCR_MUX_MODE_ALT1)
+#define SIUL2_USDHC_S32_G1_PAD_CTRL_CMD \
+	(SIUL2_USDHC_S32_G1_PAD_CTRL_BASE | \
+	 SIUL2_MSCR_S32_G1_PUS_EN | \
+	 SIUL2_MSCR_MUX_MODE_ALT1)
+#define SIUL2_USDHC_S32_G1_PAD_CTRL_DATA \
+	(SIUL2_USDHC_S32_G1_PAD_CTRL_BASE | \
+	 SIUL2_MSCR_S32_G1_PUS_EN | \
+	 SIUL2_MSCR_MUX_MODE_ALT1)
+#define SIUL2_USDHC_S32_G1_PAD_RST \
+	(SIUL2_MSCR_S32_G1_SRC_208MHz | \
+	 SIUL2_MSCR_S32_G1_OBE_EN | \
+	 SIUL2_MSCR_S32_G1_PUE_EN | \
+	 SIUL2_MSCR_S32_G1_SMC_DIS | \
+	 SIUL2_MSCR_MUX_MODE_ALT1)
 
 void s32g_plat_config_pinctrl(void);
 
diff --git a/plat/s32g/s32g_pinctrl.c b/plat/s32g/s32g_pinctrl.c
index 66103db3d..5d934ff0d 100644
--- a/plat/s32g/s32g_pinctrl.c
+++ b/plat/s32g/s32g_pinctrl.c
@@ -23,7 +23,58 @@ static void linflex_config_pinctrl(int lf)
 		      SIUL2_IMCR_S32G_G1_UART0_RXD_to_pad);
 }
 
+static void sdhc_config_pinctrl(void)
+{
+	/* Set iomux PADS for USDHC */
+
+	/* PC14 pad: uSDHC SD0_CLK_O  */
+	mmio_write_32(SIUL2_0_MSCRn(46), SIUL2_USDHC_S32_G1_PAD_CTRL_CLK);
+
+	/* PC15 pad: uSDHC SDO_CMD_0 */
+	mmio_write_32(SIUL2_0_MSCRn(47), SIUL2_USDHC_S32_G1_PAD_CTRL_CMD);
+	mmio_write_32(SIUL2_0_MSCRn(515), 0x2);
+
+	/* PD00 pad: uSDHC SD0_D_O[0] */
+	mmio_write_32(SIUL2_0_MSCRn(48), SIUL2_USDHC_S32_G1_PAD_CTRL_DATA);
+	mmio_write_32(SIUL2_0_MSCRn(516), 0x2);
+
+	/* PD01 pad: uSDHC SD0_D_O[1] */
+	mmio_write_32(SIUL2_0_MSCRn(49), SIUL2_USDHC_S32_G1_PAD_CTRL_DATA);
+	mmio_write_32(SIUL2_0_MSCRn(517), 0x2);
+
+	/* PD02 pad: uSDHC SD0_D_O[2] */
+	mmio_write_32(SIUL2_0_MSCRn(50), SIUL2_USDHC_S32_G1_PAD_CTRL_DATA);
+	mmio_write_32(SIUL2_0_MSCRn(520), 0x2);
+
+	/* PD03 pad: uSDHC SD0_D_O[3] */
+	mmio_write_32(SIUL2_0_MSCRn(51), SIUL2_USDHC_S32_G1_PAD_CTRL_DATA);
+	mmio_write_32(SIUL2_0_MSCRn(521), 0x2);
+
+	/* PD04 pad: uSDHC SD0_D_O[4] */
+	mmio_write_32(SIUL2_0_MSCRn(52), SIUL2_USDHC_S32_G1_PAD_CTRL_DATA);
+	mmio_write_32(SIUL2_0_MSCRn(522), 0x2);
+
+	/* PD05 pad: uSDHC SD0_D_O[5] */
+	mmio_write_32(SIUL2_0_MSCRn(53), SIUL2_USDHC_S32_G1_PAD_CTRL_DATA);
+	mmio_write_32(SIUL2_0_MSCRn(523), 0x2);
+
+	/* PD06 pad: uSDHC SD0_D_O[6] */
+	mmio_write_32(SIUL2_0_MSCRn(54), SIUL2_USDHC_S32_G1_PAD_CTRL_DATA);
+	mmio_write_32(SIUL2_0_MSCRn(519), 0x2);
+
+	/* PD07 pad: uSDHC SD0_D_O[7] */
+	mmio_write_32(SIUL2_0_MSCRn(55), SIUL2_USDHC_S32_G1_PAD_CTRL_DATA);
+	mmio_write_32(SIUL2_0_MSCRn(518), 0x2);
+
+	/* PD08 pad: uSDHC SDO_RST */
+	mmio_write_32(SIUL2_0_MSCRn(56), SIUL2_USDHC_S32_G1_PAD_RST);
+
+	/* PD10 pad: uSDHC SD0_DQS_I */
+	mmio_write_32(SIUL2_0_MSCRn(524), 0x2);
+}
+
 void s32g_plat_config_pinctrl(void)
 {
 	linflex_config_pinctrl(S32G_LINFLEX_MODULE);
+	sdhc_config_pinctrl();
 }
-- 
2.17.1

