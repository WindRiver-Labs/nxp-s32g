From 96e2c99e03cc3f9f80a575858100fe81cf5276b8 Mon Sep 17 00:00:00 2001
From: Dan Nica <dan.nica@nxp.com>
Date: Sat, 23 May 2020 12:53:12 +0300
Subject: [PATCH 140/269] s32g: Automatically call mkimage

Issue: ALB-4935
Upstream-Status: Pending 

Signed-off-by: Dan Nica <dan.nica@nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 plat/s32g/include/platform_def.h |  9 ++-------
 plat/s32g/platform.mk            | 12 ++++++++++++
 2 files changed, 14 insertions(+), 7 deletions(-)

diff --git a/plat/s32g/include/platform_def.h b/plat/s32g/include/platform_def.h
index 34a4d8c9e..be936305c 100644
--- a/plat/s32g/include/platform_def.h
+++ b/plat/s32g/include/platform_def.h
@@ -135,10 +135,7 @@
  * enough to prevent overflowing onto the adjacent SRAM image. Handle with care,
  * wear a helmet and compile with -Os.
  */
-/* BL2 image in SRAM */
-#define S32G_BL2_OFF_IN_SRAM	0x00300000
-#define BL2_BASE		(S32G_SRAM_BASE + \
-					S32G_BL2_OFF_IN_SRAM + DTB_SIZE)
+
 /* this may be a bit too relaxed */
 #define BL2_LIMIT		(S32G_SRAM_END - 1)
 
@@ -155,9 +152,7 @@
 #define BL31SSRAM_MAX_CODE_SIZE	(S32G_SSRAM_LIMIT - BL31SSRAM_BASE)
 #define BL31SSRAM_STACK_SIZE	0x1000
 
-/* BL2 DTB in SRAM */
-#define DTB_SIZE		U(0x00002000)   /* 8Ko for DTB */
-#define DTB_BASE		(BL2_BASE - DTB_SIZE)
+#define DTB_SIZE		(BL2_BASE - DTB_BASE)
 
 /* U-boot address in SRAM */
 #define S32G_BL33_OFF_IN_SRAM	0x00020000
diff --git a/plat/s32g/platform.mk b/plat/s32g/platform.mk
index c96f1c8e5..4cc46fa7c 100644
--- a/plat/s32g/platform.mk
+++ b/plat/s32g/platform.mk
@@ -105,6 +105,18 @@ add_to_fip: fip ${BL2_W_DTB}
 	@echo "Added BL2 and DTB to ${BUILD_PLAT}/${FIP_NAME} successfully"
 	${Q}${FIPTOOL} info ${BUILD_PLAT}/${FIP_NAME}
 
+DTB_BASE		:= 0x34300000
+$(eval $(call add_define,DTB_BASE))
+BL2_BASE		:= 0x34302000
+$(eval $(call add_define,BL2_BASE))
+
+all: call_mkimage
+call_mkimage: add_to_fip
+	$(eval MKIMAGE = $(shell dirname $(BL33))/tools/mkimage)
+	@${MKIMAGE} -e ${BL2_BASE} -a ${DTB_BASE} -T s32gen1image \
+		-d ${BUILD_PLAT}/${FIP_NAME} ${BUILD_PLAT}/fip.s32
+	@echo "Generated ${BUILD_PLAT}/fip.s32 successfully"
+
 # Disable the PSCI platform compatibility layer
 ENABLE_PLAT_COMPAT	:= 0
 
-- 
2.17.1

