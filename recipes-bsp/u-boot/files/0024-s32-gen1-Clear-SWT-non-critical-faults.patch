From def35f7917ae435ac9d5179f7efd0bac233c7d06 Mon Sep 17 00:00:00 2001
From: Ghennadi Procopciuc <Ghennadi.Procopciuc@nxp.com>
Date: Fri, 8 Jan 2021 15:50:40 +0200
Subject: [PATCH 24/76] s32-gen1: Clear SWT non-critical faults

Issue: ALB-6278
Signed-off-by: Ghennadi Procopciuc <Ghennadi.Procopciuc@nxp.com>
---
 arch/arm/cpu/armv8/s32/s32-gen1/soc.c | 40 +++++++++++++++++++++++++--
 1 file changed, 37 insertions(+), 3 deletions(-)

diff --git a/arch/arm/cpu/armv8/s32/s32-gen1/soc.c b/arch/arm/cpu/armv8/s32/s32-gen1/soc.c
index 654614a4a5..17a62bfaac 100644
--- a/arch/arm/cpu/armv8/s32/s32-gen1/soc.c
+++ b/arch/arm/cpu/armv8/s32/s32-gen1/soc.c
@@ -33,6 +33,11 @@
 #include <dt-bindings/clock/s32gen1-clock.h>
 #include <s32gen1_clk_utils.h>
 
+/* FCCU registers */
+#define FCCU_NCF_S1	(FCCU_BASE_ADDR + 0x84)
+#define FCCU_NCFK	(FCCU_BASE_ADDR + 0x90)
+#define FCCU_NCFK_KEY	(0xAB3498FE)
+
 DECLARE_GLOBAL_DATA_PTR;
 
 
@@ -246,10 +251,24 @@ U_BOOT_CMD(
 		"<start_address>"
 	  );
 
-int arch_misc_init(void)
+/**
+ * Clear non-critical faults generated by SWT (software watchdog timer)
+ * All SWT faults are placed in NCF_S1 (33-38)
+ */
+static void clear_swt_faults(void)
 {
-	int ret = 0;
+	u32 val = readl(FCCU_NCF_S1);
+
+	if (val) {
+		writel(FCCU_NCFK_KEY, FCCU_NCFK);
+		writel(val, FCCU_NCF_S1);
+	}
+}
+
 #ifdef CONFIG_SAF1508BET_USB_PHY
+static int enable_saf1508bet(void)
+{
+	int ret = 0;
 	struct udevice *dev;
 	struct phy phy;
 	struct uclass *uc;
@@ -280,11 +299,26 @@ int arch_misc_init(void)
 		return ret;
 	}
 
-	ret =  generic_phy_power_on(&phy);
+	ret = generic_phy_power_on(&phy);
 	if (ret) {
 		pr_err("failed to get %s USB PHY\n", dev->name);
 		return ret;
 	}
+
+	return ret;
+}
+#endif
+
+int arch_misc_init(void)
+{
+	int ret = 0;
+
+	clear_swt_faults();
+
+#ifdef CONFIG_SAF1508BET_USB_PHY
+	ret = enable_saf1508bet();
+	if (ret)
+		return ret;
 #endif
 	return ret;
 }
-- 
2.17.1

