From c132f96aaf2438b1e7412b9ca9e07698482d1969 Mon Sep 17 00:00:00 2001
From: Ghennadi Procopciuc <ghennadi.procopciuc@oss.nxp.com>
Date: Mon, 20 Sep 2021 12:24:08 +0300
Subject: [PATCH 06/19] s32g3: Correct the calculation of MC_RGM.PRST1_0 fields

Issue: ALB-7715
Upstream-Status: Pending 

Signed-off-by: Ghennadi Procopciuc <ghennadi.procopciuc@oss.nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 arch/arm/cpu/armv8/s32/mp.c                     |  2 +-
 arch/arm/cpu/armv8/s32/s32-gen1/s32g3_soc.c     | 17 +++++++++++++++++
 arch/arm/cpu/armv8/s32/s32-gen1/soc.c           |  9 +++++++++
 .../include/asm/arch-s32/s32-gen1/mc_rgm_regs.h |  3 ++-
 4 files changed, 29 insertions(+), 2 deletions(-)

diff --git a/arch/arm/cpu/armv8/s32/mp.c b/arch/arm/cpu/armv8/s32/mp.c
index 815a2dc905..7fb9eeb0d3 100644
--- a/arch/arm/cpu/armv8/s32/mp.c
+++ b/arch/arm/cpu/armv8/s32/mp.c
@@ -110,7 +110,7 @@ static void fsl_s32_wake_secondary_core(int prtn, int core)
 
 	/* Deassert core reset */
 	reset = readl(RGM_PRST(MC_RGM_BASE_ADDR, RGM_CORES_RESET_GROUP));
-	resetc = RGM_CORE_RST(core);
+	resetc = get_rgm_a53_bit(core);
 	reset &= ~resetc;
 	writel(reset, RGM_PRST(MC_RGM_BASE_ADDR, RGM_CORES_RESET_GROUP));
 	while ((readl(RGM_PSTAT(MC_RGM_BASE_ADDR, RGM_CORES_RESET_GROUP))
diff --git a/arch/arm/cpu/armv8/s32/s32-gen1/s32g3_soc.c b/arch/arm/cpu/armv8/s32/s32-gen1/s32g3_soc.c
index 651177b45f..dcbd8b9411 100644
--- a/arch/arm/cpu/armv8/s32/s32-gen1/s32g3_soc.c
+++ b/arch/arm/cpu/armv8/s32/s32-gen1/s32g3_soc.c
@@ -45,3 +45,20 @@ u8 mc_me_core2prtn_core_id(u8 part, u8 id)
 	return mc_me_m7_core_id[id];
 }
 
+u8 get_rgm_a53_bit(u8 core)
+{
+	static u8 periph_rgm_cores[] = {
+		/** Cluster 0, core 0*/
+		[0] = 65,
+		[1] = 66,
+		[2] = 69,
+		[3] = 70,
+		/** Cluster 1, core 0*/
+		[4] = 67,
+		[5] = 68,
+		[6] = 71,
+		[7] = 72,
+	};
+
+	return BIT(periph_rgm_cores[core] % 64);
+}
diff --git a/arch/arm/cpu/armv8/s32/s32-gen1/soc.c b/arch/arm/cpu/armv8/s32/s32-gen1/soc.c
index 16ad62c389..8fb750b153 100644
--- a/arch/arm/cpu/armv8/s32/s32-gen1/soc.c
+++ b/arch/arm/cpu/armv8/s32/s32-gen1/soc.c
@@ -388,3 +388,12 @@ __weak u8 mc_me_core2prtn_core_id(u8 part, u8 id)
 {
 	return id;
 }
+
+__weak u8 get_rgm_a53_bit(u8 core)
+{
+	/**
+	 * Bit corresponding to CA53_n in the cores'
+	 * RGM reset partition (n=0..3)
+	 */
+	return BIT(core + 1);
+}
diff --git a/arch/arm/include/asm/arch-s32/s32-gen1/mc_rgm_regs.h b/arch/arm/include/asm/arch-s32/s32-gen1/mc_rgm_regs.h
index 1c257bd1c5..8093d77e97 100644
--- a/arch/arm/include/asm/arch-s32/s32-gen1/mc_rgm_regs.h
+++ b/arch/arm/include/asm/arch-s32/s32-gen1/mc_rgm_regs.h
@@ -32,7 +32,6 @@
 #define RGM_CORES_RESET_GROUP		1
 #define RGM_PFE_RESET_GROUP		2
 
-#define RGM_CORE_RST(num)		BIT((num) + 1)
 #define RGM_PERIPH_RST(num)		BIT(num)
 
 /* S32G */
@@ -46,5 +45,7 @@
 #define PRST_PCIE_1_FUNC		17
 #define PRST_PFE			128
 
+u8 get_rgm_a53_bit(u8 core);
+
 #endif /* __ARCH_ARM_MACH_S32GEN1_MCRGM_REGS_H__ */
 
-- 
2.17.1

