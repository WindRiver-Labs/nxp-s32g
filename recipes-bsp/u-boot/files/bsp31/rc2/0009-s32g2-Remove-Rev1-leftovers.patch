From f0543f064b5bab7c68283c2fc0c008f3bb315bdc Mon Sep 17 00:00:00 2001
From: Ghennadi Procopciuc <ghennadi.procopciuc@nxp.com>
Date: Tue, 21 Sep 2021 15:00:50 +0300
Subject: [PATCH 09/19] s32g2: Remove Rev1 leftovers

Issue: ALB-7737
Upstream-Status: Pending 

Signed-off-by: Ghennadi Procopciuc <ghennadi.procopciuc@nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 arch/arm/cpu/armv8/s32/fdt.c                  | 25 -----------------
 arch/arm/cpu/armv8/s32/s32-gen1/cmu.c         |  4 ---
 arch/arm/cpu/armv8/s32/s32-gen1/include/cmu.h |  1 -
 arch/arm/cpu/armv8/s32/s32-gen1/s32g2_cmu.c   |  8 ------
 arch/arm/cpu/armv8/s32/s32-gen1/sgmii/sgmii.c | 26 +----------------
 arch/arm/include/asm/arch-s32/siul.h          | 11 +-------
 board/freescale/s32-gen1/eth.c                | 28 -------------------
 drivers/clk/s32/early_clocks.c                |  7 -----
 drivers/clk/s32/s32g274a_clk.c                | 12 --------
 drivers/pci/pcie_s32gen1.c                    | 25 -----------------
 drivers/spi/s32gen1_qspi.c                    | 12 --------
 tools/s32gen1image.c                          |  5 ----
 tools/s32gen1image.h                          |  1 -
 tools/s32gen1image_qspi_macronix.c            | 11 --------
 tools/s32gen1image_qspi_micron.c              | 11 --------
 15 files changed, 2 insertions(+), 185 deletions(-)

diff --git a/arch/arm/cpu/armv8/s32/fdt.c b/arch/arm/cpu/armv8/s32/fdt.c
index ceceb8f8c3..b8e842cb45 100644
--- a/arch/arm/cpu/armv8/s32/fdt.c
+++ b/arch/arm/cpu/armv8/s32/fdt.c
@@ -40,10 +40,6 @@
 #define SERDES_LINE_NAME_FMT	"serdes_lane%d"
 #define SERDES_LINE_NAME_LEN	sizeof(SERDES_LINE_NAME_FMT)
 
-#if defined(CONFIG_TARGET_S32G274AEVB) || defined(CONFIG_TARGET_S32G274ARDB)
-#include <dt-bindings/clock/s32gen1-clock-freq.h>
-#endif
-
 #define S32_DDR_LIMIT_VAR "ddr_limitX"
 
 #ifdef CONFIG_MP
@@ -319,24 +315,6 @@ static void apply_ddr_limits(bd_t *bd)
 	};
 }
 
-#if defined(CONFIG_TARGET_S32G274AEVB) || defined(CONFIG_TARGET_S32G274ARDB)
-static void ft_fixup_qspi_frequency(void *blob)
-{
-	const u32 qspi_freq_be = cpu_to_be32(is_s32gen1_soc_rev1() ?
-			S32G274A_REV1_QSPI_MAX_FREQ : S32GEN1_QSPI_MAX_FREQ);
-	const char *path = "/spi@40134000/mx25uw51245g@0";
-	int ret;
-
-	/* Update QSPI max frequency according to the SOC detected rev.
-	 */
-	ret = fdt_find_and_setprop(blob, path, "spi-max-frequency",
-				   &qspi_freq_be, sizeof(u32), 1);
-	if (ret)
-		printf("WARNING: Could not fix up QSPI device-tree max frequency, err=%s\n",
-		       fdt_strerror(ret));
-}
-#endif
-
 static void ft_fixup_memory(void *blob, bd_t *bd)
 {
 	hide_sram(bd);
@@ -923,9 +901,6 @@ void ft_cpu_setup(void *blob, bd_t *bd)
 	ft_fixup_clock_frequency(blob);
 #endif
 	ft_fixup_memory(blob, bd);
-#if defined(CONFIG_TARGET_S32G274AEVB) || defined(CONFIG_TARGET_S32G274ARDB)
-	ft_fixup_qspi_frequency(blob);
-#endif
 #ifdef CONFIG_SYS_ERRATUM_ERR050543
 	ft_fixup_ddr_polling(blob);
 #endif
diff --git a/arch/arm/cpu/armv8/s32/s32-gen1/cmu.c b/arch/arm/cpu/armv8/s32/s32-gen1/cmu.c
index e8650581ce..e0993b6309 100644
--- a/arch/arm/cpu/armv8/s32/s32-gen1/cmu.c
+++ b/arch/arm/cpu/armv8/s32/s32-gen1/cmu.c
@@ -333,8 +333,6 @@ static int get_fm_mon_freq(struct cmu *inst, double *mon_freq)
 	return 0;
 }
 
-__weak void cmu_fixup(void) {}
-
 static int do_verify_clocks(cmd_tbl_t *cmdtp, int flag, int argc,
 			    char * const argv[])
 {
@@ -351,8 +349,6 @@ static int do_verify_clocks(cmd_tbl_t *cmdtp, int flag, int argc,
 	puts("-----------|------------------|-----------|----------");
 	puts("|--------------------\n");
 
-	cmu_fixup();
-
 	for (i = 0; i < get_cmu_blocks_number(); i++) {
 		inst = get_cmu_block(i);
 		if (inst->fc) {
diff --git a/arch/arm/cpu/armv8/s32/s32-gen1/include/cmu.h b/arch/arm/cpu/armv8/s32/s32-gen1/include/cmu.h
index 20229d8a44..3b1c18f1fe 100644
--- a/arch/arm/cpu/armv8/s32/s32-gen1/include/cmu.h
+++ b/arch/arm/cpu/armv8/s32/s32-gen1/include/cmu.h
@@ -104,7 +104,6 @@ struct cmu {
 	bool fc;
 };
 
-void cmu_fixup(void);
 struct cmu *get_cmu_block(int index);
 int get_cmu_blocks_number(void);
 #endif
diff --git a/arch/arm/cpu/armv8/s32/s32-gen1/s32g2_cmu.c b/arch/arm/cpu/armv8/s32/s32-gen1/s32g2_cmu.c
index a9ef3a5cd9..d76979b844 100644
--- a/arch/arm/cpu/armv8/s32/s32-gen1/s32g2_cmu.c
+++ b/arch/arm/cpu/armv8/s32/s32-gen1/s32g2_cmu.c
@@ -41,14 +41,6 @@ static struct cmu cmu_blocks[] = {
 
 };
 
-void cmu_fixup(void)
-{
-#if defined(CONFIG_TARGET_S32G274AEVB) || defined(CONFIG_TARGET_S32G274ARDB)
-	if (is_s32gen1_soc_rev1())
-		cmu_blocks[17].mon_freq = 133.33;
-#endif
-}
-
 struct cmu *get_cmu_block(int index)
 {
 	return &cmu_blocks[index];
diff --git a/arch/arm/cpu/armv8/s32/s32-gen1/sgmii/sgmii.c b/arch/arm/cpu/armv8/s32/s32-gen1/sgmii/sgmii.c
index f2b1827f8d..f5b8f1190d 100644
--- a/arch/arm/cpu/armv8/s32/s32-gen1/sgmii/sgmii.c
+++ b/arch/arm/cpu/armv8/s32/s32-gen1/sgmii/sgmii.c
@@ -1,6 +1,6 @@
 // SPDX-License-Identifier: GPL-2.0
 /*
- * Copyright 2019-2020 NXP
+ * Copyright 2019-2021 NXP
  *
  * The SerDes config code
  */
@@ -49,12 +49,6 @@
  *
  */
 
-#if defined(CONFIG_TARGET_S32G274AEVB) || \
-	defined(CONFIG_TARGET_S32G274ABLUEBOX3)
-/* rev. 1.0.1*/
-#define SGMII_MIN_SOC_REV_SUPPORTED 0x1
-#endif /* CONFIG_TARGET_S32G274AEVB */
-
 struct s32_xpcs_cfg {
 	enum serdes_xpcs_mode xpcs_mode;
 	bool is_init;
@@ -241,24 +235,6 @@ int s32_eth_xpcs_init(void __iomem *serdes_base, int id,
 		      enum serdes_clock clktype,
 		      enum serdes_clock_fmhz fmhz)
 {
-#ifdef SGMII_MIN_SOC_REV_SUPPORTED
-	u32 raw_rev = 0;
-
-	/* construct a revision number based on major, minor and subminor,
-	 * each part using one hex digit
-	 */
-	raw_rev = (get_siul2_midr1_major() << 8) |
-		  (get_siul2_midr1_minor() << 4) |
-		  (get_siul2_midr2_subminor());
-
-	if (raw_rev < SGMII_MIN_SOC_REV_SUPPORTED) {
-		printf("SGMII not supported on rev.");
-		printf("%d.%d.%d\n", get_siul2_midr1_major() + 1,
-		       get_siul2_midr1_minor(),
-		       get_siul2_midr2_subminor());
-		return -ENXIO;
-	}
-#endif /* SGMII_MIN_SOC_REV_SUPPORTED */
 	int retval = 0;
 	u32 xpcs0_base;
 	u32 xpcs1_base;
diff --git a/arch/arm/include/asm/arch-s32/siul.h b/arch/arm/include/asm/arch-s32/siul.h
index 53c1452b1a..f807acb481 100644
--- a/arch/arm/include/asm/arch-s32/siul.h
+++ b/arch/arm/include/asm/arch-s32/siul.h
@@ -2,7 +2,7 @@
 /*
  * (C) Copyright 2015-2016 Freescale Semiconductor, Inc.
  * (C) Copyright 2017 MicroSys Electronics GmbH
- * Copyright 2017-2020 NXP
+ * Copyright 2017-2021 NXP
  *
  */
 
@@ -140,13 +140,4 @@ static inline int get_siul2_midr2_subminor(void)
 
 #endif  /* CONFIG_S32_GEN1 */
 
-#if defined(CONFIG_NXP_S32G2XX)
-/* If SOC REV < 2, QSPI clock max frequency should be 133,33MHz. */
-static inline bool is_s32gen1_soc_rev1(void)
-{
-	return (get_siul2_midr1_major() < 1);
-}
-
-#endif
-
 #endif /*__ARCH_ARM_MACH_S32V234_SIUL_H__ */
diff --git a/board/freescale/s32-gen1/eth.c b/board/freescale/s32-gen1/eth.c
index ee24a6f7b6..794a1c481c 100644
--- a/board/freescale/s32-gen1/eth.c
+++ b/board/freescale/s32-gen1/eth.c
@@ -151,27 +151,6 @@ static void ft_enet_pfe_emac_fixup(u32 idx, void *fdt)
 	}
 }
 
-static void ft_enet_compatible_fixup(void *fdt, int nodeoff)
-{
-#ifndef CONFIG_NXP_S32G3XX
-	if (!is_s32gen1_soc_rev1())
-		return;
-#endif
-
-	fdt_setprop_string(fdt, nodeoff, "compatible",
-			   "fsl,s32g274a-pfeng-cut1.1");
-}
-
-static void ft_enet_coherent_fixup(void *fdt, int nodeoff)
-{
-#ifndef CONFIG_NXP_S32G3XX
-	if (is_s32gen1_soc_rev1())
-		if (fdt_getprop(fdt, nodeoff, "dma-coherent", NULL))
-			if (fdt_delprop(fdt, nodeoff, "dma-coherent"))
-				pr_err("Failed to remove dma-coherent\n");
-#endif
-}
-
 static bool pfeng_drv_status_active(void)
 {
 	struct udevice *dev;
@@ -208,13 +187,6 @@ void ft_enet_fixup(void *fdt)
 			ft_enet_pfe_emac_fixup(0, fdt);
 			ft_enet_pfe_emac_fixup(1, fdt);
 			ft_enet_pfe_emac_fixup(2, fdt);
-
-			/*
-			 * Remove dma-coherent and change 'compatible'
-			 * for Rev 1
-			 */
-			ft_enet_coherent_fixup(fdt, nodeoff);
-			ft_enet_compatible_fixup(fdt, nodeoff);
 		}
 	}
 #endif /* CONFIG_IS_ENABLED(FSL_PFENG) */
diff --git a/drivers/clk/s32/early_clocks.c b/drivers/clk/s32/early_clocks.c
index da6e70d190..4e6d8f825c 100644
--- a/drivers/clk/s32/early_clocks.c
+++ b/drivers/clk/s32/early_clocks.c
@@ -161,13 +161,6 @@ static int enable_ddr_clock(void)
 	ddr_pll_freq = S32GEN1_DDR_PLL_VCO_FREQ;
 	ddr_freq = S32GEN1_DDR_FREQ;
 
-#ifdef CONFIG_NXP_S32G2XX
-	if (!is_s32gen1_soc_rev1()) {
-		ddr_pll_freq = S32G274A_REV2_DDR_PLL_VCO_FREQ;
-		ddr_freq = S32G274A_REV2_DDR_FREQ;
-	}
-#endif
-
 	ret = s32gen1_set_parent(&ddr_pll_mux, &fxosc);
 	if (ret)
 		return ret;
diff --git a/drivers/clk/s32/s32g274a_clk.c b/drivers/clk/s32/s32g274a_clk.c
index f67619e99e..45d9ff879f 100644
--- a/drivers/clk/s32/s32g274a_clk.c
+++ b/drivers/clk/s32/s32g274a_clk.c
@@ -113,21 +113,9 @@ struct s32gen1_clk *s32g_get_plat_clock(uint32_t id)
 
 ulong s32gen1_plat_set_rate(struct clk *c, ulong rate)
 {
-	ulong qspi_max_rate;
-
 	if (s32gen1_scmi_request(c))
 		return 0;
 
-	if (is_qspi_clk(c->id)) {
-		if (is_qspi2x_clk(c->id))
-			qspi_max_rate = S32G274A_REV1_QSPI_MAX_FREQ * 2;
-		else
-			qspi_max_rate = S32G274A_REV1_QSPI_MAX_FREQ;
-
-		if (is_s32gen1_soc_rev1() && rate > qspi_max_rate)
-			rate = qspi_max_rate;
-	}
-
 	return s32gen1_scmi_set_rate(c, rate);
 }
 
diff --git a/drivers/pci/pcie_s32gen1.c b/drivers/pci/pcie_s32gen1.c
index d793d04f08..07fe2b8e15 100644
--- a/drivers/pci/pcie_s32gen1.c
+++ b/drivers/pci/pcie_s32gen1.c
@@ -39,15 +39,6 @@
 "BusDevFun           VendorId   DeviceId   Device Class       Sub-Class\n" \
 "______________________________________________________________________\n"
 
-
-#if defined(CONFIG_TARGET_S32G274AEVB) || \
-	defined(CONFIG_TARGET_S32G274ABLUEBOX3)
-/* First SOC revision with functional PCIe: rev 1.0.1, which means
- * major 0, minor 0, subminor 1
- */
-#define PCIE_MIN_SOC_REV_SUPPORTED 0x1
-#endif
-
 #define PCI_MAX_BUS_NUM	256
 
 DECLARE_GLOBAL_DATA_PTR;
@@ -893,22 +884,6 @@ static int s32_pcie_probe(struct udevice *dev)
 	bool ltssm_en = false;
 	pcie->enabled = false;
 
-#ifdef PCIE_MIN_SOC_REV_SUPPORTED
-	uint32_t raw_rev = 0;
-
-	/* construct a revision number based on major, minor and subminor,
-	 * each part using one hex digit
-	 */
-	raw_rev = (get_siul2_midr1_major() << 8) |
-		(get_siul2_midr1_minor() << 4) |
-		(get_siul2_midr2_subminor());
-
-	if (raw_rev < PCIE_MIN_SOC_REV_SUPPORTED) {
-		printf("PCIe%d: PCIe not supported\n", pcie->id);
-		return -ENXIO;
-	}
-#endif
-
 	debug("%s: probing %s\n", __func__, dev->name);
 	if (!pcie) {
 		printf("PCIe%d: invalid internal data\n", pcie->id);
diff --git a/drivers/spi/s32gen1_qspi.c b/drivers/spi/s32gen1_qspi.c
index 25dd1e6196..ec3727a213 100644
--- a/drivers/spi/s32gen1_qspi.c
+++ b/drivers/spi/s32gen1_qspi.c
@@ -682,12 +682,6 @@ static int enable_ddr(struct fsl_qspi_priv *priv)
 	mcr &= ~QSPI_MCR_MDIS_MASK;
 	qspi_write32(priv->flags, &regs->mcr, mcr);
 
-#if defined(CONFIG_TARGET_S32G274AEVB) || \
-	defined(CONFIG_TARGET_S32G274ARDB) || \
-	defined(CONFIG_TARGET_S32G274ABLUEBOX3)
-	if (is_s32gen1_soc_rev1())
-		ddr_config.dllcr &= ~QSPI_DLLCR_FREQEN_EN;
-#endif
 #if defined(CONFIG_TARGET_S32R45EVB)
 	ddr_config.dllcr &= ~QSPI_DLLCR_FREQEN_EN;
 #endif
@@ -705,12 +699,6 @@ static int enable_ddr(struct fsl_qspi_priv *priv)
 }
 
 int s32gen1_enable_spi(struct fsl_qspi_priv *priv, bool force)
-
-
-
-
-
-
 {
 	struct fsl_qspi_regs *regs = priv->regs;
 	u32 mcr;
diff --git a/tools/s32gen1image.c b/tools/s32gen1image.c
index eb72ba3c98..7e44ad7a9e 100644
--- a/tools/s32gen1image.c
+++ b/tools/s32gen1image.c
@@ -152,11 +152,6 @@ static void s32gen1_set_qspi_params(struct qspi_params *qspi_params)
 	struct qspi_params *s32g2xx_qspi_conf = get_s32g2xx_qspi_conf();
 
 	memcpy(qspi_params, s32g2xx_qspi_conf, sizeof(*qspi_params));
-#if defined(CONFIG_S32G274ARDB) || defined(CONFIG_TARGET_S32R45EVB) || \
-	defined(CONFIG_TARGET_S32G274AEVB) ||\
-	defined(CONFIG_TARGET_S32G274ABLUEBOX3)
-	adjust_qspi_params(qspi_params);
-#endif
 }
 #endif /* CONFIG_TARGET_TYPE_S32GEN1_EMULATOR */
 #endif
diff --git a/tools/s32gen1image.h b/tools/s32gen1image.h
index baa8a697b0..2224c17df1 100644
--- a/tools/s32gen1image.h
+++ b/tools/s32gen1image.h
@@ -136,6 +136,5 @@ struct program_image {
 };
 
 struct qspi_params *get_s32g2xx_qspi_conf(void);
-void adjust_qspi_params(struct qspi_params *qspi_params);
 
 #endif /* S32GEN1IMAGE_H */
diff --git a/tools/s32gen1image_qspi_macronix.c b/tools/s32gen1image_qspi_macronix.c
index 3b95db7917..21322b5455 100644
--- a/tools/s32gen1image_qspi_macronix.c
+++ b/tools/s32gen1image_qspi_macronix.c
@@ -6,17 +6,6 @@
 #include "s32gen1image.h"
 
 #ifdef CONFIG_FLASH_BOOT
-/* Load U-Boot using DTR octal mode @ 133 MHz*/
-#if defined(CONFIG_S32G274ARDB) || defined(CONFIG_TARGET_S32R45EVB) || \
-	defined(CONFIG_TARGET_S32G274AEVB) || \
-	defined(CONFIG_TARGET_S32G274ABLUEBOX3)
-void adjust_qspi_params(struct qspi_params *qspi_params)
-{
-	qspi_params->dllcr = 0x8280000c;
-	qspi_params->dll_slv_upd_en = 0x01;
-	qspi_params->sflash_clk_freq = 133;
-}
-#endif
 static struct qspi_params s32g2xx_qspi_conf = {
 	.header   = 0x5a5a5a5a,
 	.mcr      = 0x030f00cc,
diff --git a/tools/s32gen1image_qspi_micron.c b/tools/s32gen1image_qspi_micron.c
index 012ddb6470..b34551e0b7 100644
--- a/tools/s32gen1image_qspi_micron.c
+++ b/tools/s32gen1image_qspi_micron.c
@@ -6,17 +6,6 @@
 #include "s32gen1image.h"
 
 #ifdef CONFIG_FLASH_BOOT
-/* Load U-Boot using DTR octal mode @ 133 MHz*/
-#if defined(CONFIG_S32G274ARDB) || defined(CONFIG_TARGET_S32R45EVB) || \
-	defined(CONFIG_TARGET_S32G274AEVB) || \
-	defined(CONFIG_TARGET_S32G274ABLUEBOX3)
-void adjust_qspi_params(struct qspi_params *qspi_params)
-{
-	qspi_params->dllcr = 0x42860704;
-	qspi_params->dll_slv_upd_en = 0x01;
-	qspi_params->sflash_clk_freq = 133;
-}
-#endif
 static struct qspi_params s32g2xx_qspi_conf = {
 	.header   = 0x5a5a5a5a,
 	.mcr      = 0x010f00cc,
-- 
2.17.1

