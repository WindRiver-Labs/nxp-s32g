From 24211a8e4705849e8353e640f3fc96e827bbdea9 Mon Sep 17 00:00:00 2001
From: Ghennadi Procopciuc <ghennadi.procopciuc@nxp.com>
Date: Fri, 29 Oct 2021 11:18:56 +0300
Subject: [PATCH 06/19] s32g3: mc_me Correct the way A53 cluster is enabled

Issue: ALB-8016
Upstream-Status: Pending 

Signed-off-by: Ghennadi Procopciuc <ghennadi.procopciuc@nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 arch/arm/cpu/armv8/s32/mp.c                         |  9 +--------
 arch/arm/cpu/armv8/s32/s32-gen1/s32g3_soc.c         | 10 ++++++++++
 arch/arm/cpu/armv8/s32/s32-gen1/soc.c               | 10 ++++++++++
 arch/arm/include/asm/arch-s32/s32-gen1/mc_me_regs.h |  1 +
 4 files changed, 22 insertions(+), 8 deletions(-)

diff --git a/arch/arm/cpu/armv8/s32/mp.c b/arch/arm/cpu/armv8/s32/mp.c
index 9b2aa3c957..2120672c3c 100644
--- a/arch/arm/cpu/armv8/s32/mp.c
+++ b/arch/arm/cpu/armv8/s32/mp.c
@@ -72,14 +72,7 @@ static unsigned long get_core_start_addr(int core)
 
 static void enable_a53_core_cluster(int core)
 {
-	/* For S32G2/S32R45 we have the following mapping:
-	 * MC_ME_PRTN1_CORE0_* -> CA53 cluster0 core0/1
-	 * MC_ME_PRTN1_CORE2_* -> CA53 cluster1 core0/1
-	 * For G32G3 we have the following mapping:
-	 * MC_ME_PRTN1_CORE0_* -> CA53 cluster0 core0/1/2/3
-	 * MC_ME_PRTN1_CORE2_* -> CA53 cluster1 core0/1/2/3
-	 */
-	u32 pconf_cluster = (core % 4) & ~1;
+	u32 pconf_cluster = mc_me_get_cluster_ptrn(core);
 	u32 prtn = MC_ME_CORES_PRTN;
 	u32 stat;
 
diff --git a/arch/arm/cpu/armv8/s32/s32-gen1/s32g3_soc.c b/arch/arm/cpu/armv8/s32/s32-gen1/s32g3_soc.c
index dc58f7e88b..f2a727c8bc 100644
--- a/arch/arm/cpu/armv8/s32/s32-gen1/s32g3_soc.c
+++ b/arch/arm/cpu/armv8/s32/s32-gen1/s32g3_soc.c
@@ -62,3 +62,13 @@ u8 get_rgm_a53_bit(u8 core)
 
 	return periph_rgm_cores[core] % 64;
 }
+
+u32 mc_me_get_cluster_ptrn(u32 core)
+{
+	/**
+	 * For G32G3 we have the following mapping:
+	 *     MC_ME_PRTN1_CORE0_* -> CA53 cluster0 core0/1/2/3
+	 *     MC_ME_PRTN1_CORE2_* -> CA53 cluster1 core0/1/2/3
+	 */
+	return mc_me_core2prtn_core_id(MC_ME_CORES_PRTN, core) & 2;
+}
diff --git a/arch/arm/cpu/armv8/s32/s32-gen1/soc.c b/arch/arm/cpu/armv8/s32/s32-gen1/soc.c
index 69277fe0c6..edb56e66f8 100644
--- a/arch/arm/cpu/armv8/s32/s32-gen1/soc.c
+++ b/arch/arm/cpu/armv8/s32/s32-gen1/soc.c
@@ -397,3 +397,13 @@ __weak u8 get_rgm_a53_bit(u8 core)
 	 */
 	return core + 1;
 }
+
+__weak u32 mc_me_get_cluster_ptrn(u32 core)
+{
+	/**
+	 * For S32G2/S32R45 we have the following mapping:
+	 *     MC_ME_PRTN1_CORE0_* -> CA53 cluster0 core0/1
+	 *     MC_ME_PRTN1_CORE2_* -> CA53 cluster1 core0/1
+	 */
+	return (core % 4) & ~1;
+}
diff --git a/arch/arm/include/asm/arch-s32/s32-gen1/mc_me_regs.h b/arch/arm/include/asm/arch-s32/s32-gen1/mc_me_regs.h
index 7aeaf903a3..53fe1b9dda 100644
--- a/arch/arm/include/asm/arch-s32/s32-gen1/mc_me_regs.h
+++ b/arch/arm/include/asm/arch-s32/s32-gen1/mc_me_regs.h
@@ -85,6 +85,7 @@
 #define RDC_RD_STAT_XBAR_DISABLE_MASK	BIT(4)
 
 u8 mc_me_core2prtn_core_id(u8 part, u8 id);
+u32 mc_me_get_cluster_ptrn(u32 core);
 
 #endif
 
-- 
2.17.1

