From a27fcd7e806dcb369ca7079a2db161af2443eb5f Mon Sep 17 00:00:00 2001
From: Ghennadi Procopciuc <ghennadi.procopciuc@nxp.com>
Date: Wed, 27 Oct 2021 10:43:48 +0300
Subject: [PATCH 05/19] s32g3: Correct GICR base address

Issue: ALB-8016
Upstream-Status: Pending 

Signed-off-by: Ghennadi Procopciuc <ghennadi.procopciuc@nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 arch/arm/dts/fsl-s32g.dtsi        |  1 -
 arch/arm/dts/fsl-s32g274a.dtsi    |  1 -
 arch/arm/dts/fsl-s32g274aevb.dts  |  1 +
 arch/arm/dts/fsl-s32g398a.dtsi    | 18 +++++++++++++++---
 arch/arm/dts/fsl-s32g398aemu.dts  | 15 +--------------
 arch/arm/dts/fsl-s32g3xxaevb.dts  |  2 ++
 arch/arm/dts/fsl-s32gxxxaevb.dtsi |  2 --
 include/configs/s32-gen1.h        |  3 ++-
 8 files changed, 21 insertions(+), 22 deletions(-)

diff --git a/arch/arm/dts/fsl-s32g.dtsi b/arch/arm/dts/fsl-s32g.dtsi
index 30be09af07..8e49768b4d 100644
--- a/arch/arm/dts/fsl-s32g.dtsi
+++ b/arch/arm/dts/fsl-s32g.dtsi
@@ -11,7 +11,6 @@
 #include <dt-bindings/clock/s32g-scmi-clock.h>
 #include <dt-bindings/pinctrl/s32g-pinctrl.h>
 
-/dts-v1/;
 #include "fsl-s32-gen1.dtsi"
 / {
 	model = "NXP S32G2XX";
diff --git a/arch/arm/dts/fsl-s32g274a.dtsi b/arch/arm/dts/fsl-s32g274a.dtsi
index 0a20ae6d39..0318680155 100644
--- a/arch/arm/dts/fsl-s32g274a.dtsi
+++ b/arch/arm/dts/fsl-s32g274a.dtsi
@@ -8,7 +8,6 @@
  * (at your option) any later version.
  */
 
-/dts-v1/;
 #include "fsl-s32g.dtsi"
 / {
 	model = "NXP S32G2XX";
diff --git a/arch/arm/dts/fsl-s32g274aevb.dts b/arch/arm/dts/fsl-s32g274aevb.dts
index 508d674176..503701b25c 100644
--- a/arch/arm/dts/fsl-s32g274aevb.dts
+++ b/arch/arm/dts/fsl-s32g274aevb.dts
@@ -4,4 +4,5 @@
  */
 
 /dts-v1/;
+#include "fsl-s32g274a.dtsi"
 #include "fsl-s32gxxxaevb.dtsi"
diff --git a/arch/arm/dts/fsl-s32g398a.dtsi b/arch/arm/dts/fsl-s32g398a.dtsi
index 993b2e456c..a57f809c15 100644
--- a/arch/arm/dts/fsl-s32g398a.dtsi
+++ b/arch/arm/dts/fsl-s32g398a.dtsi
@@ -9,9 +9,7 @@
  */
 #include <dt-bindings/clock/s32g3-clock.h>
 
-/dts-v1/;
-
-#include "fsl-s32g.dtsi"
+/delete-node/ &gic;
 / {
 	model = "NXP S32G3XX";
 	compatible = "fsl,s32g398", "fsl,s32gen1",
@@ -31,6 +29,20 @@
 		device_type = "memory";
 		reg = <0 0x34000000 0 0x1400000>;
 	};
+
+	gic: interrupt-controller@50800000 {
+		compatible = "arm,gic-v3";
+		#interrupt-cells = <3>;
+		#address-cells = <2>;
+		#size-cells = <2>;
+		interrupt-controller;
+		reg = <0 0x50800000 0 0x10000>, /* GIC Dist */
+		      <0 0x50900000 0 0x200000>, /* GICR (RD_base + SGI_base) */
+		      <0 0x50400000 0 0x2000>, /* GICC */
+		      <0 0x50410000 0 0x2000>, /* GICH */
+		      <0 0x50420000 0 0x2000>; /* GICV */
+		interrupts = <1 9 0xf04>;
+	};
 };
 
 /delete-node/ &mc_cgm0;
diff --git a/arch/arm/dts/fsl-s32g398aemu.dts b/arch/arm/dts/fsl-s32g398aemu.dts
index bc8e070885..8e2e595249 100644
--- a/arch/arm/dts/fsl-s32g398aemu.dts
+++ b/arch/arm/dts/fsl-s32g398aemu.dts
@@ -4,25 +4,12 @@
  */
 
 /dts-v1/;
+#include "fsl-s32g.dtsi"
 #include "fsl-s32g398a.dtsi"
 
-/delete-node/ &gic;
 /delete-node/ &mem1;
 /delete-node/ &mem2;
 / {
-	gic: interrupt-controller@50800000 {
-		compatible = "arm,gic-v3";
-		#interrupt-cells = <3>;
-		#address-cells = <2>;
-		#size-cells = <2>;
-		interrupt-controller;
-		reg = <0 0x50800000 0 0x10000>, /* GIC Dist */
-		      <0 0x50900000 0 0x200000>, /* GICR (RD_base + SGI_base) */
-		      <0 0x50400000 0 0x2000>, /* GICC */
-		      <0 0x50410000 0 0x2000>, /* GICH */
-		      <0 0x50420000 0 0x2000>; /* GICV */
-		interrupts = <1 9 0xf04>;
-	};
 
 	mem1: memory@80000000 {
 		device_type = "memory";
diff --git a/arch/arm/dts/fsl-s32g3xxaevb.dts b/arch/arm/dts/fsl-s32g3xxaevb.dts
index 508d674176..5f98441235 100644
--- a/arch/arm/dts/fsl-s32g3xxaevb.dts
+++ b/arch/arm/dts/fsl-s32g3xxaevb.dts
@@ -4,4 +4,6 @@
  */
 
 /dts-v1/;
+#include "fsl-s32g.dtsi"
+#include "fsl-s32g398a.dtsi"
 #include "fsl-s32gxxxaevb.dtsi"
diff --git a/arch/arm/dts/fsl-s32gxxxaevb.dtsi b/arch/arm/dts/fsl-s32gxxxaevb.dtsi
index 65679d8dcb..bab63cb31a 100644
--- a/arch/arm/dts/fsl-s32gxxxaevb.dtsi
+++ b/arch/arm/dts/fsl-s32gxxxaevb.dtsi
@@ -3,9 +3,7 @@
  * Copyright 2019-2021 NXP
  */
 
-/dts-v1/;
 #include <dt-bindings/gpio/gpio.h>
-#include "fsl-s32g274a.dtsi"
 
 / {
 	aliases {
diff --git a/include/configs/s32-gen1.h b/include/configs/s32-gen1.h
index 0a0d28e29d..8de5ae284b 100644
--- a/include/configs/s32-gen1.h
+++ b/include/configs/s32-gen1.h
@@ -95,7 +95,8 @@
 #define CONFIG_GICV3
 #define GIC_BASE	0x50800000
 #define GICD_BASE	GIC_BASE
-#ifdef CONFIG_TARGET_TYPE_S32GEN1_EMULATOR
+#if defined(CONFIG_TARGET_TYPE_S32GEN1_EMULATOR) || \
+	defined(CONFIG_NXP_S32G3XX)
 #define GICR_BASE	(GIC_BASE + 0x100000)
 #else
 #define GICR_BASE	(GIC_BASE + 0x80000)
-- 
2.17.1

