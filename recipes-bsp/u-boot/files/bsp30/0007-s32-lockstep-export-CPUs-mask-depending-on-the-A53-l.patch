From 3d898a6459c18e817a42001617ab64a96ffe4a73 Mon Sep 17 00:00:00 2001
From: Catalin Udma <catalin-dan.udma@nxp.com>
Date: Fri, 11 Jun 2021 10:07:15 +0300
Subject: [PATCH 07/14] s32: lockstep: export CPUs mask depending on the A53
 lockstep status

Upstream-Status: Pending

Issue: ALB-6703

Signed-off-by: Catalin Udma <catalin-dan.udma@nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 arch/arm/cpu/armv8/s32/s32-gen1/s32g274a.c | 5 -----
 arch/arm/cpu/armv8/s32/s32-gen1/soc.c      | 5 ++++-
 2 files changed, 4 insertions(+), 6 deletions(-)

diff --git a/arch/arm/cpu/armv8/s32/s32-gen1/s32g274a.c b/arch/arm/cpu/armv8/s32/s32-gen1/s32g274a.c
index 2eca45c416..816fcd5981 100644
--- a/arch/arm/cpu/armv8/s32/s32-gen1/s32g274a.c
+++ b/arch/arm/cpu/armv8/s32/s32-gen1/s32g274a.c
@@ -37,11 +37,6 @@ u32 cpu_pos_mask_cluster1(void)
 	return 0;
 }
 
-u32 cpu_pos_mask(void)
-{
-	return cpu_pos_mask_cluster0() | cpu_pos_mask_cluster1();
-}
-
 u32 get_sram_size(void)
 {
 	switch (get_s32g2_derivative()) {
diff --git a/arch/arm/cpu/armv8/s32/s32-gen1/soc.c b/arch/arm/cpu/armv8/s32/s32-gen1/soc.c
index 80f2eb0133..84256bea54 100644
--- a/arch/arm/cpu/armv8/s32/s32-gen1/soc.c
+++ b/arch/arm/cpu/armv8/s32/s32-gen1/soc.c
@@ -14,6 +14,7 @@
 #include <asm/arch/cse.h>
 #include <asm/arch/imx-regs.h>
 #include <asm/arch/cpu.h>
+#include <asm/arch/s32-gen1/a53_cluster_gpr.h>
 #include <asm/arch/s32-gen1/mc_me_regs.h>
 #include <asm/arch/s32-gen1/mc_rgm_regs.h>
 #if defined(CONFIG_SYS_FSL_DDRSS) && defined(CONFIG_TARGET_TYPE_S32GEN1_EMULATOR)
@@ -43,7 +44,9 @@ DECLARE_GLOBAL_DATA_PTR;
 
 __weak u32 cpu_pos_mask(void)
 {
-	return CPUMASK_CLUSTER0 | CPUMASK_CLUSTER1;
+	if (is_a53_lockstep_enabled())
+		return cpu_pos_mask_cluster0();
+	return cpu_pos_mask_cluster0() | cpu_pos_mask_cluster1();
 }
 
 __weak u32 cpu_pos_mask_cluster0(void)
-- 
2.17.1

