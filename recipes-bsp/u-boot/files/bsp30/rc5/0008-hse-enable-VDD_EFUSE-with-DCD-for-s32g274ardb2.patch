From 3fc8f1ea527e30d2f338c51b745ee6cb2f821177 Mon Sep 17 00:00:00 2001
From: Vlad Pelin <vlad.pelin@nxp.com>
Date: Wed, 11 Aug 2021 22:27:19 +0300
Subject: [PATCH 8/8] hse: enable VDD_EFUSE with DCD for s32g274ardb2

Upstream-Status: Pending

Issue: ALB-7409
Signed-off-by: Vlad Pelin <vlad.pelin@nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 tools/s32gen1image.c | 13 +++++++++++++
 tools/s32gen1image.h |  4 +++-
 2 files changed, 16 insertions(+), 1 deletion(-)

diff --git a/tools/s32gen1image.c b/tools/s32gen1image.c
index bfa3ae6f77..eb72ba3c98 100644
--- a/tools/s32gen1image.c
+++ b/tools/s32gen1image.c
@@ -4,6 +4,7 @@
 #include <image.h>
 #include <generated/autoconf.h>
 #include <config.h>
+#include <asm/arch-s32/siul-s32-gen1.h>
 #include "imagetool.h"
 #include "s32_common.h"
 #include "s32gen1image.h"
@@ -66,10 +67,22 @@ static struct program_image image_layout = {
 
 static uint32_t dcd_data[] = {
 	DCD_HEADER,
+
+/*
+ * Enable VDD_EFUSE, so that HSE can read SYS_IMG.
+ * VDD_EFUSE is disabled by default on s32g274ardb2
+ */
+#ifdef CONFIG_S32G274ARDB2
+	DCD_WRITE_HEADER(1, PARAMS_BYTES(4)),
+	DCD_ADDR(SIUL2_0_MSCRn(25)), DCD_MASK(MSCR25_SET_GPIO25_SRC),
+	DCD_WRITE_HEADER(1, PARAMS_BYTES(1)),
+	DCD_ADDR(SIUL2_PDO_N(25)), DCD_MASK(GPDO25_HIGH),
+#else
 	DCD_NOP_HEADER,
 	DCD_NOP_HEADER,
 	DCD_NOP_HEADER,
 	DCD_NOP_HEADER,
+#endif
 };
 
 static struct ivt *get_ivt(struct program_image *image)
diff --git a/tools/s32gen1image.h b/tools/s32gen1image.h
index 759ac3d2a6..baa8a697b0 100644
--- a/tools/s32gen1image.h
+++ b/tools/s32gen1image.h
@@ -32,7 +32,9 @@ struct fip_image_data {
 #define LCCW_IN_FIELD			(1 << 1)
 #define LCCW_OEM_PROD			(1 << 0)
 
-#define DCD_HEADER			(0x600000d2)
+#define DCD_HEADER            (0x600000d2)
+#define MSCR25_SET_GPIO25_SRC (0x21c000)
+#define GPDO25_HIGH           (0x1)
 
 #define IVT_VERSION			(0x60)
 #define APPLICATION_BOOT_CODE_TAG	(0xd5)
-- 
2.17.1

