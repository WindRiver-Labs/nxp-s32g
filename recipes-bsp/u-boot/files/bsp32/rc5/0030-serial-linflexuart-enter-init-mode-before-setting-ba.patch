From 1877f9376a7b5800e554e911d3994739e79fec49 Mon Sep 17 00:00:00 2001
From: "Radu Pirea (NXP OSS)" <radu-nicolae.pirea@oss.nxp.com>
Date: Thu, 10 Feb 2022 16:56:36 +0200
Subject: [PATCH 30/43] serial: linflexuart: enter init mode before setting
 baudrate

Issue: ALB-8504

Upstream-Status: Pending 

Signed-off-by: Radu Pirea (NXP OSS) <radu-nicolae.pirea@oss.nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 drivers/serial/serial_linflexuart.c | 47 +++++++++++++++++++++--------
 1 file changed, 34 insertions(+), 13 deletions(-)

diff --git a/drivers/serial/serial_linflexuart.c b/drivers/serial/serial_linflexuart.c
index 6af9470d54..4371dfafcd 100644
--- a/drivers/serial/serial_linflexuart.c
+++ b/drivers/serial/serial_linflexuart.c
@@ -64,6 +64,34 @@ struct linflex_fsl {
 	u32 uartpto;
 };
 
+static void _linflex_enter_init(struct linflex_fsl *base)
+{
+	u32 ctrl;
+
+	/* wait the TX fifo to be empty */
+	while (__raw_readl(&base->uartcr) & UARTCR_TFC)
+		;
+
+	/* set the Linflex in init mode */
+	ctrl = __raw_readl(&base->lincr1);
+	ctrl |= LINCR1_INIT;
+	__raw_writel(ctrl, &base->lincr1);
+
+	/* waiting for init mode entry - TODO: add a timeout */
+	while ((__raw_readl(&base->linsr) & LINSR_LINS_MASK) !=
+	       LINSR_LINS_INITMODE)
+		;
+}
+
+static void _linflex_exit_init(struct linflex_fsl *base)
+{
+	u32 ctrl;
+
+	ctrl = __raw_readl(&base->lincr1);
+	ctrl &= ~LINCR1_INIT;
+	__raw_writel(ctrl, &base->lincr1);
+}
+
 static u32 linflex_ldiv_multiplier(struct linflex_fsl *base)
 {
 #ifdef CONFIG_TARGET_TYPE_S32GEN1_EMULATOR
@@ -130,19 +158,12 @@ static int _linflex_serial_init(struct linflex_fsl *base, ulong rate)
 {
 	volatile u32 ctrl;
 
-	/* wait the TX fifo to be empty */
-	while (__raw_readl(&base->uartcr) & UARTCR_TFC)
-		;
+	_linflex_enter_init(base);
 
-	/* set the Linflex in master|init mode and activate by-pass filter
-	 * (where supported) */
-	ctrl = LINCR1_MME | LINCR1_INIT;
+	ctrl = __raw_readl(&base->lincr1);
+	ctrl |= LINCR1_MME;
 	__raw_writel(ctrl, &base->lincr1);
 
-	/* waiting for init mode entry - TODO: add a timeout */
-	while ((__raw_readl(&base->linsr) & LINSR_LINS_MASK) !=
-	       LINSR_LINS_INITMODE);
-
 	/* set UART bit to allow writing other bits */
 	__raw_writel(UARTCR_UART, &base->uartcr);
 
@@ -159,9 +180,7 @@ static int _linflex_serial_init(struct linflex_fsl *base, ulong rate)
 	/* provide data bits, parity, stop bit, etc */
 	_linflex_serial_setbrg(base, rate, CONFIG_BAUDRATE);
 
-	ctrl = __raw_readl(&base->lincr1);
-	ctrl &= ~LINCR1_INIT;
-	__raw_writel(ctrl, &base->lincr1);	/* end init mode */
+	_linflex_exit_init(base);
 
 	return 0;
 }
@@ -175,8 +194,10 @@ int linflex_serial_setbrg(struct udevice *dev, int baudrate)
 {
 	struct linflex_serial_priv *priv = dev_get_priv(dev);
 
+	_linflex_enter_init(priv->lfuart);
 	_linflex_serial_setbrg(priv->lfuart, clk_get_rate(&priv->clk),
 			       baudrate);
+	_linflex_exit_init(priv->lfuart);
 
 	return 0;
 }
-- 
2.17.1

