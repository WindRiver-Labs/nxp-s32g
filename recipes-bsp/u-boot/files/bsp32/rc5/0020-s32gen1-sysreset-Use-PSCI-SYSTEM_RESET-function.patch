From 886305b32058a464dddbcf9cf58b01ae8e29f5cc Mon Sep 17 00:00:00 2001
From: Ciprian Costea <ciprianmarian.costea@nxp.com>
Date: Thu, 10 Feb 2022 12:42:35 +0200
Subject: [PATCH 20/43] s32gen1: sysreset: Use PSCI SYSTEM_RESET function

Issue: ALB-8490
Upstream-Status: Pending 

Signed-off-by: Ciprian Costea <ciprianmarian.costea@nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 arch/arm/cpu/armv8/s32/s32-gen1/soc.c             | 15 ---------------
 .../include/asm/arch-s32/s32-gen1/mc_me_regs.h    |  8 +-------
 board/freescale/Kconfig                           |  2 ++
 3 files changed, 3 insertions(+), 22 deletions(-)

diff --git a/arch/arm/cpu/armv8/s32/s32-gen1/soc.c b/arch/arm/cpu/armv8/s32/s32-gen1/soc.c
index c540b00dfa..6a05b54fcd 100644
--- a/arch/arm/cpu/armv8/s32/s32-gen1/soc.c
+++ b/arch/arm/cpu/armv8/s32/s32-gen1/soc.c
@@ -76,21 +76,6 @@ int enable_i2c_clk(unsigned char enable, unsigned i2c_num)
 	return 0;
 }
 
-void reset_cpu(ulong addr)
-{
-	writel(MC_ME_MODE_CONF_FUNC_RST, MC_ME_MODE_CONF(MC_ME_BASE_ADDR));
-
-	writel(MC_ME_MODE_UPD_UPD, MC_ME_MODE_UPD(MC_ME_BASE_ADDR));
-
-	writel(MC_ME_CTL_KEY_KEY, MC_ME_CTL_KEY(MC_ME_BASE_ADDR));
-	writel(MC_ME_CTL_KEY_INVERTEDKEY, MC_ME_CTL_KEY(MC_ME_BASE_ADDR));
-
-	/* If we get there, we are not in good shape */
-	mdelay(1000);
-	printf("FATAL: Reset Failed!\n");
-	hang();
-}
-
 __weak int dram_init(void)
 {
 	return 0;
diff --git a/arch/arm/include/asm/arch-s32/s32-gen1/mc_me_regs.h b/arch/arm/include/asm/arch-s32/s32-gen1/mc_me_regs.h
index 53fe1b9dda..f0a6a24591 100644
--- a/arch/arm/include/asm/arch-s32/s32-gen1/mc_me_regs.h
+++ b/arch/arm/include/asm/arch-s32/s32-gen1/mc_me_regs.h
@@ -1,7 +1,7 @@
 /* SPDX-License-Identifier: BSD-3-Clause */
 /*
  * (C) Copyright 2015-2016 Freescale Semiconductor, Inc.
- * Copyright 2017-2021 NXP
+ * Copyright 2017-2022 NXP
  */
 
 #ifndef __ARCH_ARM_MACH_S32GEN1_MCME_REGS_H__
@@ -15,12 +15,6 @@
 #define MC_ME_CTL_KEY_KEY		(0x00005AF0)
 #define MC_ME_CTL_KEY_INVERTEDKEY	(0x0000A50F)
 
-#define MC_ME_MODE_CONF(MC_ME)		(UPTR(MC_ME) + 0x00000004)
-#define MC_ME_MODE_CONF_FUNC_RST	(0x1 << 1)
-
-#define MC_ME_MODE_UPD(MC_ME)		(UPTR(MC_ME) + 0x00000008)
-#define MC_ME_MODE_UPD_UPD		(0x1 << 0)
-
 #define MC_ME_MODE_STAT(MC_ME)		(UPTR(MC_ME) + 0x0000000C)
 #define MC_ME_MODE_STAT_PREVMODE	(0x1 << 0)
 
diff --git a/board/freescale/Kconfig b/board/freescale/Kconfig
index 7cbe14906a..545a2e2587 100644
--- a/board/freescale/Kconfig
+++ b/board/freescale/Kconfig
@@ -31,6 +31,8 @@ config S32_GEN1
 	select MMC_HS400_SUPPORT if !TARGET_TYPE_S32GEN1_EMULATOR
 	select MMC_HS400_ES_SUPPORT if !TARGET_TYPE_S32GEN1_EMULATOR
 	select SYS_MALLOC_F
+	select SYSRESET
+	select SYSRESET_PSCI
 	select CPU
 	help
 	  Platform Selection
-- 
2.17.1

