From 3d026899a42e1216c59a1c538c5faf65dadfab2d Mon Sep 17 00:00:00 2001
From: "Radu Pirea (NXP OSS)" <radu-nicolae.pirea@oss.nxp.com>
Date: Wed, 2 Feb 2022 11:33:48 +0200
Subject: [PATCH 32/64] serial: linflex: add optimisations for s32gen1 emulator

Issue: ALB-8368

Upstream-Status: Pending 

Signed-off-by: Radu Pirea (NXP OSS) <radu-nicolae.pirea@oss.nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 drivers/serial/serial_linflexuart.c | 13 ++++++++++++-
 1 file changed, 12 insertions(+), 1 deletion(-)

diff --git a/drivers/serial/serial_linflexuart.c b/drivers/serial/serial_linflexuart.c
index 2c212adeb6..b720737aab 100644
--- a/drivers/serial/serial_linflexuart.c
+++ b/drivers/serial/serial_linflexuart.c
@@ -36,10 +36,17 @@
 #define LINFLEXD_UARTCR_ROSE		BIT(23)
 #define LINFLEX_LDIV_MULTIPLIER		(16)
 
+#ifdef CONFIG_TARGET_TYPE_S32GEN1_EMULATOR
+#define LIN_CLK			133000	// LIN_CLK in Hz
+#endif
+
 DECLARE_GLOBAL_DATA_PTR;
 
 static u32 linflex_ldiv_multiplier(struct linflex_fsl *base)
 {
+#ifdef CONFIG_TARGET_TYPE_S32GEN1_EMULATOR
+	return 1;
+#endif
 	u32 mul = LINFLEX_LDIV_MULTIPLIER;
 	u32 cr;
 
@@ -53,7 +60,11 @@ static u32 linflex_ldiv_multiplier(struct linflex_fsl *base)
 
 static void _linflex_serial_setbrg(struct linflex_fsl *base, int baudrate)
 {
+#ifdef CONFIG_TARGET_TYPE_S32GEN1_EMULATOR
+	u32 clk = LIN_CLK;
+#else
 	u32 clk = mxc_get_clock(MXC_UART_CLK);
+#endif
 	u32 ibr, fbr, divisr, dividr;
 
 	if (!baudrate)
@@ -108,7 +119,7 @@ static int _linflex_serial_init(struct linflex_fsl *base)
 	/* set UART bit to allow writing other bits */
 	__raw_writel(UARTCR_UART, &base->uartcr);
 
-#ifdef VIRTUAL_PLATFORM
+#ifdef CONFIG_TARGET_TYPE_S32GEN1_EMULATOR
 	/* Set preset timeout register value. Otherwise, print is very slow. */
 	__raw_writel(0xf, &base->uartpto);
 #endif
-- 
2.17.1

