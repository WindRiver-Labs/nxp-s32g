From ea1c84321b92ef92f1640048447f983ca8ba85f6 Mon Sep 17 00:00:00 2001
From: Ghennadi Procopciuc <ghennadi.procopciuc@nxp.com>
Date: Thu, 27 Jan 2022 09:33:32 +0200
Subject: [PATCH 62/64] tools: s32gen1image: Place APP header as the last
 component

Issue: ALB-8432
Upstream-Status: Pending 

Signed-off-by: Ghennadi Procopciuc <ghennadi.procopciuc@nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 tools/s32gen1image.c | 12 ++++++++----
 1 file changed, 8 insertions(+), 4 deletions(-)

diff --git a/tools/s32gen1image.c b/tools/s32gen1image.c
index 084d2d0f39..a726729940 100644
--- a/tools/s32gen1image.c
+++ b/tools/s32gen1image.c
@@ -553,8 +553,6 @@ static int s32g2xx_build_layout(struct program_image *program_image,
 		&program_image->ivt,
 		get_image_dcd(program_image),
 		get_image_hse_params(program_image),
-		&program_image->app_code,
-		&program_image->code,
 	};
 	size_t last_comp = ARRAY_SIZE(parts) - 1;
 
@@ -563,9 +561,15 @@ static int s32g2xx_build_layout(struct program_image *program_image,
 	/* Compute auto-offsets */
 	s32_compute_dyn_offsets(parts, ARRAY_SIZE(parts));
 
-	qsort(&parts[0], ARRAY_SIZE(parts), sizeof(parts[0]), image_parts_comp);
+	/**
+	 * Place APP header at the end of the image header as the APP code
+	 * will be glued to it.
+	 */
+	place_after(parts[last_comp], &program_image->app_code);
+	place_after(&program_image->app_code, &program_image->code);
 
-	*header_size = parts[last_comp]->offset + parts[last_comp]->size;
+	*header_size = program_image->app_code.offset +
+	    program_image->app_code.size;
 
 	image_layout = calloc(*header_size, sizeof(*image_layout));
 	if (!image_layout) {
-- 
2.17.1

