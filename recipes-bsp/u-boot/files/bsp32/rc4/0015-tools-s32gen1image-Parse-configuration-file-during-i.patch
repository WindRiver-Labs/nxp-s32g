From a3d9792e485e0b6b23954d9367257408d147b37b Mon Sep 17 00:00:00 2001
From: Ghennadi Procopciuc <ghennadi.procopciuc@nxp.com>
Date: Thu, 20 Jan 2022 09:41:41 +0200
Subject: [PATCH 15/64] tools: s32gen1image: Parse configuration file during
 image header build

Issue: ALB-8303
Upstream-Status: Pending 

Signed-off-by: Ghennadi Procopciuc <ghennadi.procopciuc@nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 tools/imagetool.h    |  1 -
 tools/mkimage.c      |  9 ---------
 tools/s32gen1image.c | 33 +++++++++++++++++++--------------
 3 files changed, 19 insertions(+), 24 deletions(-)

diff --git a/tools/imagetool.h b/tools/imagetool.h
index 28b31728eb..e1c778b0df 100644
--- a/tools/imagetool.h
+++ b/tools/imagetool.h
@@ -254,7 +254,6 @@ int zynqmpbif_copy_image(int fd, struct image_tool_params *mparams);
 int imx8image_copy_image(int fd, struct image_tool_params *mparams);
 int imx8mimage_copy_image(int fd, struct image_tool_params *mparams);
 int rockchip_copy_image(int fd, struct image_tool_params *mparams);
-int s32gen1_parse_config(int fd, struct image_tool_params *mparams);
 
 #define ___cat(a, b) a ## b
 #define __cat(a, b) ___cat(a, b)
diff --git a/tools/mkimage.c b/tools/mkimage.c
index 5ab8a4fcdd..5f51d2cc89 100644
--- a/tools/mkimage.c
+++ b/tools/mkimage.c
@@ -554,15 +554,6 @@ int main(int argc, char **argv)
 				return ret;
 		} else {
 			copy_file(ifd, params.datafile, pad_len);
-
-			if (params.type == IH_TYPE_S32GEN1IMAGE) {
-				/* S32GEN1 has special Image format */
-				int ret;
-
-				ret = s32gen1_parse_config(ifd, &params);
-				if (ret)
-					return ret;
-			}
 		}
 		if (params.type == IH_TYPE_FIRMWARE_IVT) {
 			/* Add alignment and IVT */
diff --git a/tools/s32gen1image.c b/tools/s32gen1image.c
index 8c4f786b38..697de8264a 100644
--- a/tools/s32gen1image.c
+++ b/tools/s32gen1image.c
@@ -509,19 +509,6 @@ static int s32g2xx_build_layout(struct program_image *program_image,
 	return 0;
 }
 
-static int s32gen1_vrec_header(struct image_tool_params *tool_params,
-			       struct image_type_params *type_params)
-{
-	size_t header_size;
-	void *image = NULL;
-
-	s32g2xx_build_layout(&image_layout, &header_size, &image);
-	type_params->header_size = header_size;
-	type_params->hdr = image;
-
-	return 0;
-}
-
 static bool is_ivt_header(const void *ptr)
 {
 	struct ivt *ivt = (struct ivt *)ptr;
@@ -945,7 +932,7 @@ static int build_conf(FILE *fconf)
 	return 0;
 }
 
-int s32gen1_parse_config(int outfd, struct image_tool_params *mparams)
+static int s32gen1_parse_config(struct image_tool_params *mparams)
 {
 	FILE *fconf;
 	int ret;
@@ -963,6 +950,24 @@ int s32gen1_parse_config(int outfd, struct image_tool_params *mparams)
 	return ret;
 }
 
+static int s32gen1_vrec_header(struct image_tool_params *tool_params,
+			       struct image_type_params *type_params)
+{
+	size_t header_size;
+	void *image = NULL;
+	int ret;
+
+	ret = s32gen1_parse_config(tool_params);
+	if (ret)
+		return ret;
+
+	s32g2xx_build_layout(&image_layout, &header_size, &image);
+	type_params->header_size = header_size;
+	type_params->hdr = image;
+
+	return 0;
+}
+
 static int s32gen1_check_params(struct image_tool_params *params)
 {
 	if (!params)
-- 
2.17.1

