From 4369b80d98e7a1d1e8f5fdcc9a09a96caa5ec395 Mon Sep 17 00:00:00 2001
From: Ghennadi Procopciuc <ghennadi.procopciuc@nxp.com>
Date: Thu, 13 Jan 2022 11:22:53 +0200
Subject: [PATCH 05/64] pci: s32-gen1: Use SIUL2 NVRAM to check SerDes presence

Issue: ALB-8339
Upstream-Status: Pending 

Signed-off-by: Ghennadi Procopciuc <ghennadi.procopciuc@nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 arch/arm/include/asm/arch-s32/siul.h | 30 ------------------------
 drivers/pci/Makefile                 |  1 +
 drivers/pci/pcie_s32gen1.c           | 35 +++++++++++++++++++++-------
 3 files changed, 28 insertions(+), 38 deletions(-)

diff --git a/arch/arm/include/asm/arch-s32/siul.h b/arch/arm/include/asm/arch-s32/siul.h
index 913551de2f..ac4ced3830 100644
--- a/arch/arm/include/asm/arch-s32/siul.h
+++ b/arch/arm/include/asm/arch-s32/siul.h
@@ -58,7 +58,6 @@
 #define SIUL2_MIDR2_FREQ_SHIFT		(16)
 #define SIUL2_MIDR2_FREQ_MASK		(0xF << SIUL2_MIDR2_FREQ_SHIFT)
 
-#ifdef CONFIG_S32_GEN1
 #ifdef CONFIG_NXP_S32R45
 #define SIUL2_MIDR2_SUBMINOR_SHIFT	(0)
 #define SIUL2_MIDR2_SUBMINOR_MASK	(0x1 << SIUL2_MIDR2_SUBMINOR_SHIFT)
@@ -69,9 +68,6 @@
 #define SIUL2_MIDR1_DERIV_MASK		(0xFFFF0000U)
 #define SIUL2_MIDR1_OFF			(16U)
 #define SIUL2_MIDR2_SERDES			BIT(15)
-#endif  /* CONFIG_S32_GEN1 */
-
-#define TREERUNNER_GENERATION_2_MAJOR	1
 
 #include "siul-s32-gen1.h"
 
@@ -123,36 +119,10 @@ static inline const char *get_s32g2_deriv_name(void)
 }
 #endif
 
-static inline int get_siul2_midr1_minor(void)
-{
-	return (readl(SIUL2_MIDR1) & SIUL2_MIDR1_MINOR_MASK);
-}
-
-static inline int get_siul2_midr1_major(void)
-{
-	return ((readl(SIUL2_MIDR1) & SIUL2_MIDR1_MAJOR_MASK)
-			>> SIUL2_MIDR1_MAJOR_SHIFT);
-}
-
 static inline u32 get_siul2_midr2_freq(void)
 {
 	return ((readl(SIUL2_MIDR2) & SIUL2_MIDR2_FREQ_MASK)
 			>> SIUL2_MIDR2_FREQ_SHIFT);
 }
 
-#if !defined(CONFIG_TARGET_TYPE_S32GEN1_SIMULATOR)
-
-static inline int get_siul2_midr2_subminor(void)
-{
-	return ((readl(SIUL2_1_MIDR2) & SIUL2_MIDR2_SUBMINOR_MASK)
-			>> SIUL2_MIDR2_SUBMINOR_SHIFT);
-}
-
-static inline int is_serdes_subsystem_present(void)
-{
-	return (readl(SIUL2_1_MIDR2) & SIUL2_MIDR2_SERDES);
-}
-
-#endif  /* CONFIG_S32_GEN1 */
-
 #endif /*____ARCH_ARM_MACH_S32_SIUL_H__ */
diff --git a/drivers/pci/Makefile b/drivers/pci/Makefile
index d2942d1c73..c6e4f6a22f 100644
--- a/drivers/pci/Makefile
+++ b/drivers/pci/Makefile
@@ -4,6 +4,7 @@
 # Wolfgang Denk, DENX Software Engineering, wd@denx.de.
 
 ccflags-$(CONFIG_SERDES_S32GEN1) += -Iarch/$(ARCH)/include/asm/arch-s32/s32-gen1
+ccflags-$(CONFIG_PCIE_S32GEN1) += -Idrivers/misc
 
 ifneq ($(CONFIG_DM_PCI),)
 obj-$(CONFIG_DM_VIDEO) += pci_rom.o
diff --git a/drivers/pci/pcie_s32gen1.c b/drivers/pci/pcie_s32gen1.c
index 26b525d965..9900454149 100644
--- a/drivers/pci/pcie_s32gen1.c
+++ b/drivers/pci/pcie_s32gen1.c
@@ -1,6 +1,6 @@
 // SPDX-License-Identifier: GPL-2.0+
 /*
- * Copyright 2020-2021 NXP
+ * Copyright 2020-2022 NXP
  * S32Gen1 PCIe driver
  */
 
@@ -15,6 +15,9 @@
 #include <dm/device-internal.h>
 #include <asm/arch-s32/siul.h>
 #include <hwconfig.h>
+#include <dm/uclass.h>
+#include <misc.h>
+#include <s32gen1_siul2_nvram.h>
 
 /* CFG1 is used in linux when finding devices on the bus.
  * It is actually the upper half of the config space
@@ -894,10 +897,33 @@ static int s32_pcie_probe(struct udevice *dev)
 	int ret = 0;
 	bool ltssm_en = false;
 	ulong dev_data = dev_get_driver_data(dev);
+	u32 soc_serdes_presence;
+	struct udevice *siul21_nvmem = NULL;
 
 	pcie->enabled = false;
 	pcie->no_check_serdes = false;
 
+	ret = uclass_get_device_by_name(UCLASS_MISC, "siul2_1_nvram",
+					&siul21_nvmem);
+	if (ret) {
+		printf("%s: No SIUL21 NVMEM (err = %d)\n", __func__, ret);
+		return ret;
+	}
+
+	ret = misc_read(siul21_nvmem, S32GEN1_SERDES_PRESENCE,
+			&soc_serdes_presence,
+			sizeof(soc_serdes_presence));
+	if (ret != sizeof(soc_serdes_presence)) {
+		printf("%s: Failed to read SoC's SerDes capability (err = %d)\n",
+		       __func__, ret);
+		return -EINVAL;
+	}
+
+	if (!soc_serdes_presence) {
+		printf("SerDes Subsystem is not present, skipping configuring PCIe\n");
+		return -ENODEV;
+	}
+
 	debug("%s: probing %s\n", __func__, dev->name);
 	if (!pcie) {
 		printf("PCIe%d: invalid internal data\n", pcie->id);
@@ -912,13 +938,6 @@ static int s32_pcie_probe(struct udevice *dev)
 	if (ret)
 		return ret;
 
-	if (!pcie->no_check_serdes) {
-		if (!is_serdes_subsystem_present()) {
-			printf("SerDes Subsystem is not present, skipping configuring PCIe\n");
-			return -ENODEV;
-		}
-	}
-
 	ltssm_en = is_s32gen1_pcie_ltssm_enabled(pcie);
 	if (!ltssm_en) {
 		printf("PCIe%d: Not configuring PCIe, PHY not configured\n",
-- 
2.17.1

