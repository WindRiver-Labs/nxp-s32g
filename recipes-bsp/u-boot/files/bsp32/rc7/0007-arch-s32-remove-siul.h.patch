From 32fb1d04642061ae88f58e9e54b55209e864c09f Mon Sep 17 00:00:00 2001
From: "Radu Pirea (NXP OSS)" <radu-nicolae.pirea@oss.nxp.com>
Date: Wed, 9 Feb 2022 11:23:03 +0200
Subject: [PATCH 07/51] arch: s32: remove siul.h

Issue: ALB-8367

Upstream-Status: Pending 

Signed-off-by: Radu Pirea (NXP OSS) <radu-nicolae.pirea@oss.nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 arch/arm/cpu/armv8/s32/fdt.c                  |  1 -
 arch/arm/cpu/armv8/s32/s32-gen1/s32g274a.c    | 42 ++++++++++-
 arch/arm/cpu/armv8/s32/s32-gen1/s32g2_cmu.c   |  4 +-
 arch/arm/cpu/armv8/s32/s32-gen1/sgmii/sgmii.c |  2 -
 arch/arm/include/asm/arch-s32/siul.h          | 70 -------------------
 arch/arm/include/asm/arch-s32/soc.h           |  1 -
 drivers/pci/pcie_s32gen1.c                    |  1 -
 drivers/pci/serdes_s32gen1.c                  |  1 -
 drivers/pci/serdes_s32gen1.h                  |  1 +
 drivers/spi/s32gen1_qspi.c                    |  3 +-
 10 files changed, 44 insertions(+), 82 deletions(-)
 delete mode 100644 arch/arm/include/asm/arch-s32/siul.h

diff --git a/arch/arm/cpu/armv8/s32/fdt.c b/arch/arm/cpu/armv8/s32/fdt.c
index bb6d5bfa67..bd6d1a302a 100644
--- a/arch/arm/cpu/armv8/s32/fdt.c
+++ b/arch/arm/cpu/armv8/s32/fdt.c
@@ -10,7 +10,6 @@
 #include <fdt_support.h>
 #include <fdtdec.h>
 #include <asm/io.h>
-#include <asm/arch/siul.h>
 #include <linux/sizes.h>
 #include <hwconfig.h>
 #include <asm/arch-s32/s32-gen1/serdes_hwconfig.h>
diff --git a/arch/arm/cpu/armv8/s32/s32-gen1/s32g274a.c b/arch/arm/cpu/armv8/s32/s32-gen1/s32g274a.c
index 816fcd5981..f67265c77c 100644
--- a/arch/arm/cpu/armv8/s32/s32-gen1/s32g274a.c
+++ b/arch/arm/cpu/armv8/s32/s32-gen1/s32g274a.c
@@ -1,11 +1,49 @@
 // SPDX-License-Identifier:     GPL-2.0+
 /*
- * Copyright 2021 NXP
+ * Copyright 2021-2022 NXP
  */
 #include <common.h>
+#include <dm.h>
 #include <linux/sizes.h>
+#include <misc.h>
 #include <asm/arch/cpu.h>
-#include <asm/arch/siul.h>
+#include <s32gen1_siul2_nvram.h>
+
+enum s32g2_derivative {
+	S32G274A_DERIV,
+	S32G254A_DERIV,
+	S32G233A_DERIV,
+	S32G2_INVAL_DERIV,
+};
+
+static inline int get_s32g2_derivative(void)
+{
+	struct udevice *siul20_nvmem = NULL;
+	u32 deriv = 0;
+	int ret;
+
+	ret = uclass_get_device_by_name(UCLASS_MISC, "siul2_0_nvram",
+					&siul20_nvmem);
+	if (ret < 0)
+		return ret;
+
+	ret = misc_read(siul20_nvmem, S32GEN1_SOC_PART_NO, &deriv,
+			sizeof(deriv));
+	if (ret < 0)
+		return ret;
+
+	switch (deriv) {
+	case 0x1D12U:
+		return S32G274A_DERIV;
+	case 0x1CFEU:
+		return S32G254A_DERIV;
+	case 0x1CE9U:
+		return S32G233A_DERIV;
+	};
+
+	pr_err("Invalid S32G2 derivative: 0x%x\n", deriv);
+	return S32G2_INVAL_DERIV;
+}
 
 u32 cpu_pos_mask_cluster0(void)
 {
diff --git a/arch/arm/cpu/armv8/s32/s32-gen1/s32g2_cmu.c b/arch/arm/cpu/armv8/s32/s32-gen1/s32g2_cmu.c
index 7a2eecbbd0..4c238c37d9 100644
--- a/arch/arm/cpu/armv8/s32/s32-gen1/s32g2_cmu.c
+++ b/arch/arm/cpu/armv8/s32/s32-gen1/s32g2_cmu.c
@@ -1,9 +1,9 @@
 // SPDX-License-Identifier: GPL-2.0+
 /*
- * Copyright 2020-2021 NXP
+ * Copyright 2020-2022 NXP
  */
 
-#include <asm/arch/siul.h>
+#include <common.h>
 #include <cmu.h>
 
 static struct cmu cmu_blocks[] = {
diff --git a/arch/arm/cpu/armv8/s32/s32-gen1/sgmii/sgmii.c b/arch/arm/cpu/armv8/s32/s32-gen1/sgmii/sgmii.c
index 3920d8393f..8178c1005f 100644
--- a/arch/arm/cpu/armv8/s32/s32-gen1/sgmii/sgmii.c
+++ b/arch/arm/cpu/armv8/s32/s32-gen1/sgmii/sgmii.c
@@ -15,8 +15,6 @@
 #include <log.h>
 #include <dm.h>
 
-#include <asm/arch-s32/siul.h>
-
 #include <serdes_regs.h>
 #include <serdes_xpcs_regs.h>
 
diff --git a/arch/arm/include/asm/arch-s32/siul.h b/arch/arm/include/asm/arch-s32/siul.h
deleted file mode 100644
index 1d10fb77e0..0000000000
--- a/arch/arm/include/asm/arch-s32/siul.h
+++ /dev/null
@@ -1,70 +0,0 @@
-/* SPDX-License-Identifier: GPL-2.0+ */
-/*
- * (C) Copyright 2015-2016 Freescale Semiconductor, Inc.
- * (C) Copyright 2017 MicroSys Electronics GmbH
- * Copyright 2017-2022 NXP
- *
- */
-
-#ifndef __ARCH_ARM_MACH_S32_SIUL_H__
-#define __ARCH_ARM_MACH_S32_SIUL_H__
-
-#include "s32-gen1/s32-gen1-regs.h"
-#include <asm/io.h>
-#include <linux/bitops.h>
-
-#define SIUL2_MIDR1				(SIUL2_0_BASE_ADDR + 0x00000004)
-#define SIUL2_MIDR2				(SIUL2_0_BASE_ADDR + 0x00000008)
-
-#define SIUL2_MIDR1_DERIV_MASK		(0xFFFF0000U)
-#define SIUL2_MIDR1_OFF			(16U)
-
-#ifdef CONFIG_NXP_S32G2XX
-enum s32g2_derivative {
-	S32G274A_DERIV,
-	S32G254A_DERIV,
-	S32G233A_DERIV,
-	S32G2_INVAL_DERIV,
-};
-
-static inline enum s32g2_derivative get_s32g2_derivative(void)
-{
-	u32 deriv;
-
-	deriv = readl(SIUL2_MIDR1) & SIUL2_MIDR1_DERIV_MASK;
-	deriv >>= SIUL2_MIDR1_OFF;
-
-	switch (deriv) {
-	case 0x1D12U:
-		return S32G274A_DERIV;
-	case 0x1CFEU:
-		return S32G254A_DERIV;
-	case 0x1CE9U:
-		return S32G233A_DERIV;
-	};
-
-	pr_err("Invalid S32G2 derivative: 0x%x\n", deriv);
-	return S32G2_INVAL_DERIV;
-}
-
-static inline const char *get_s32g2_deriv_name(void)
-{
-	enum s32g2_derivative deriv;
-
-	deriv = get_s32g2_derivative();
-	switch (deriv) {
-	case S32G274A_DERIV:
-		return "S32G274A";
-	case S32G254A_DERIV:
-		return "S32G254A";
-	case S32G233A_DERIV:
-		return "S32G233A";
-	case S32G2_INVAL_DERIV:
-		return "INVAL";
-	}
-
-	return "INVAL";
-}
-#endif
-
-#endif /*____ARCH_ARM_MACH_S32_SIUL_H__ */
diff --git a/arch/arm/include/asm/arch-s32/soc.h b/arch/arm/include/asm/arch-s32/soc.h
index be700a4f4f..1a892c518c 100644
--- a/arch/arm/include/asm/arch-s32/soc.h
+++ b/arch/arm/include/asm/arch-s32/soc.h
@@ -7,7 +7,6 @@
 #define __ARCH_S32_SOC_H
 
 #include "s32-gen1/s32-gen1-regs.h"
-#include <asm/arch/siul.h>
 #include <asm/arch/clock.h>
 #include <asm/arch/mmdc.h>
 
diff --git a/drivers/pci/pcie_s32gen1.c b/drivers/pci/pcie_s32gen1.c
index 9900454149..4ab0c1c3cd 100644
--- a/drivers/pci/pcie_s32gen1.c
+++ b/drivers/pci/pcie_s32gen1.c
@@ -13,7 +13,6 @@
 #include <asm/arch/clock.h>
 #include <linux/sizes.h>
 #include <dm/device-internal.h>
-#include <asm/arch-s32/siul.h>
 #include <hwconfig.h>
 #include <dm/uclass.h>
 #include <misc.h>
diff --git a/drivers/pci/serdes_s32gen1.c b/drivers/pci/serdes_s32gen1.c
index 146d780cab..46092592e2 100644
--- a/drivers/pci/serdes_s32gen1.c
+++ b/drivers/pci/serdes_s32gen1.c
@@ -14,7 +14,6 @@
 #include <linux/sizes.h>
 #include <dm/device-internal.h>
 #include <dm/device_compat.h>
-#include <asm/arch-s32/siul.h>
 #include <hwconfig.h>
 #include <clk.h>
 
diff --git a/drivers/pci/serdes_s32gen1.h b/drivers/pci/serdes_s32gen1.h
index 61e0ca45f5..29dae1c04f 100644
--- a/drivers/pci/serdes_s32gen1.h
+++ b/drivers/pci/serdes_s32gen1.h
@@ -9,6 +9,7 @@
 
 #include <pci.h>
 #include <dm.h>
+#include <asm/arch/s32-gen1/s32-gen1-regs.h>
 #include <asm/io.h>
 
 #include "serdes_regs.h"
diff --git a/drivers/spi/s32gen1_qspi.c b/drivers/spi/s32gen1_qspi.c
index ec3727a213..7976dda320 100644
--- a/drivers/spi/s32gen1_qspi.c
+++ b/drivers/spi/s32gen1_qspi.c
@@ -1,11 +1,10 @@
 // SPDX-License-Identifier: GPL-2.0+
 /*
- * Copyright 2020-2021 NXP
+ * Copyright 2020-2022 NXP
  */
 #include "fsl_qspi.h"
 #include <cpu_func.h>
 #include <asm/io.h>
-#include <asm/arch/siul.h>
 #include <linux/mtd/spi-nor.h>
 #include <spi-mem.h>
 #include <inttypes.h>
-- 
2.17.1

