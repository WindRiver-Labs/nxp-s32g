From 0aba10c787eaa62d657b17aa24de42b0e48c8c56 Mon Sep 17 00:00:00 2001
From: Vlad Pelin <vlad.pelin@nxp.com>
Date: Thu, 18 Nov 2021 19:35:07 +0200
Subject: [PATCH 1/2] pkcs: fix tokenInit breaking libp11/pkcs11-tool

Issue: ALB-8211
Upstream-Status: Pending 

Signed-off-by: Vlad Pelin <vlad.pelin@nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 libpkcs/pkcs11.c         | 10 +---------
 libpkcs/pkcs11_context.h |  2 --
 2 files changed, 1 insertion(+), 11 deletions(-)

diff --git a/libpkcs/pkcs11.c b/libpkcs/pkcs11.c
index e00ad2c..5cd3736 100644
--- a/libpkcs/pkcs11.c
+++ b/libpkcs/pkcs11.c
@@ -56,7 +56,7 @@ static CK_FUNCTION_LIST gFunctionList = {
 	.C_SignInit =                           C_SignInit,
 	.C_Sign =                               C_Sign,
 	.C_VerifyInit =                         C_VerifyInit,
-	.C_Verify =                             C_Verify
+	.C_Verify =                             C_Verify,
 	.C_SeedRandom =                         C_SeedRandom,
 	.C_GenerateRandom =                     C_GenerateRandom
 };
@@ -212,7 +212,6 @@ CK_DEFINE_FUNCTION(CK_RV, C_Finalize)(
 	list_destroy(&gCtx->objects);
 
 	gCtx->cryptokiInit = CK_FALSE;
-	gCtx->tokenInit = CK_FALSE;
 
 	return CKR_OK;
 }
@@ -466,10 +465,6 @@ CK_DEFINE_FUNCTION(CK_RV, C_InitToken)(
 	CK_UTF8CHAR_PTR pLabel
 )
 {
-	struct globalCtx *gCtx = getCtx();
-
-	gCtx->tokenInit = CK_TRUE;
-
     return CKR_OK;
 }
 
@@ -524,9 +519,6 @@ CK_DEFINE_FUNCTION(CK_RV, C_OpenSession)(
 	if ((Notify && !pApplication) || (!Notify && pApplication))
 		return CKR_ARGUMENTS_BAD;
 
-	if (!gCtx->tokenInit)
-		return CKR_TOKEN_NOT_RECOGNIZED;
-
 	if (flags & CKF_RW_SESSION) {
 		if (pToken->ulRwSessionCount >= pToken->ulMaxRwSessionCount)
 			return CKR_SESSION_COUNT;
diff --git a/libpkcs/pkcs11_context.h b/libpkcs/pkcs11_context.h
index 9b824ae..8279025 100644
--- a/libpkcs/pkcs11_context.h
+++ b/libpkcs/pkcs11_context.h
@@ -96,7 +96,6 @@ struct hse_keyObject {
  * struct globalCtx - global context for PKCS11 operations
  *
  * @cryptokiInit:     check if cryptoki has been initialized
- * @tokenInit:        check if token has been initialized
  * @session:          session info
  * @slot:             slot info
  * @token:            token info
@@ -107,7 +106,6 @@ struct hse_keyObject {
  */
 struct globalCtx {
 	CK_BBOOL cryptokiInit;
-	CK_BBOOL tokenInit;
 	CK_SESSION_INFO session;
 	CK_SLOT_INFO slot;
 	CK_TOKEN_INFO token;
-- 
2.17.1

